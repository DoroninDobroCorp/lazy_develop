# SLOTH RUN LOG
# –¶–µ–ª–µ–≤–æ–π –ø—Ä–æ–µ–∫—Ç: /Users/vladimirdoronin/VovkaNowEngineer/lazy_develop/lazy_develop
# –†–µ–∂–∏–º: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π

================================================================================
–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: PLANNING)
--------------------------------------------------------------------------------

–¢—ã ‚Äî AI-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. –¢–≤–æ—è –ø–µ—Ä–≤–∞—è –∏ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è—Ç–µ–Ω.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–Ø:**

1.  **–ê–Ω–∞–ª–∏–∑ –ó–∞–¥–∞—á–∏:** –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π **—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π** –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã).
2.  **–î–≤–∞ –ü—É—Ç–∏ –†–∞–∑–≤–∏—Ç–∏—è:**
    *   **–ü—É—Ç—å –ê: –ó–∞–¥–∞—á–∞ –ù–ï–ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ—á–µ—Ç–∫–æ, –Ω–µ–ø–æ–ª–Ω–æ –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–ª—å–∑—è –Ω–∞–π—Ç–∏ –≤ –∫–æ–¥–µ ‚Äî **–∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ** –±–ª–æ–∫ ```clarification ... ``` —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–ª–∞–Ω –∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π —Ñ–∞–π–ª—ã.
    *   **–ü—É—Ç—å –ë: –ó–∞–¥–∞—á–∞ –ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ —Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. –¢–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  **–ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π:** ```plan ... ```. –û–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–º.
        2.  **–°–ø–∏—Å–æ–∫ –§–∞–π–ª–æ–≤:** ```files ... ```. –ü–µ—Ä–µ—á–∏—Å–ª–∏ **–≤—Å–µ** —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ, –ø–æ —Ç–≤–æ–µ–º—É –º–Ω–µ–Ω–∏—é, –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞. –£–∫–∞–∑—ã–≤–∞–π –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ. –ù–µ —ç–∫–æ–Ω–æ–º—å! –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –∫–∞—á–µ—Å—Ç–≤–æ - –∑–∞–ø—Ä–æ—Å–∏ –≤—Å–µ —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–ª–∏ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è!!! –≠—Ç–æ –≤–∞–∂–Ω–æ - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ö–ê–ß–ï–°–¢–í–û!
3.  **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ **–ó–ê–ü–†–ï–©–ï–ù–û** –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ```bash``` –∏–ª–∏ ```summary```. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ª–∏–±–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ª–∏–±–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∞–π–ª—ã.

**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `sed, rm, mv, touch, mkdir, npm, npx, yarn, pnpm, git, echo, ./, cat`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.



--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–°–û–ö–†–ê–©–ï–ù–ù–´–ô) ---
–°–µ–π—á–∞—Å —è –≤—ã–≥—Ä—É–∂—É –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞: —Å–Ω–∞—á–∞–ª–∞ –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –≤ —Å–∏–º–≤–æ–ª–∞—Ö, –∞ –ø–æ—Ç–æ–º –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

--- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ ---
lazy_develop/
‚îú‚îÄ‚îÄ colors.py (664 chars)
‚îú‚îÄ‚îÄ !!!context_collector.py (6540 chars)
‚îú‚îÄ‚îÄ !!!sloth_cli.py (17600 chars)
‚îú‚îÄ‚îÄ !!!sloth_core.py (13197 chars)
‚îî‚îÄ‚îÄ sloth_runner.py (4141 chars)

--- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ ---

–§–∞–π–ª: colors.py
---------------
# File: colors.py
# Summary of declarations:

class Colors:
    ... # implementation

–§–∞–π–ª: context_collector.py
--------------------------
# File: context_collector.py
# Summary of declarations:

def _get_file_content(filepath)
    ... # implementation

def _summarize_content(content, filepath)
    ... # implementation

def _should_ignore(path, root_dir)
    ... # implementation

def gather_project_context(root_dir, mode='full', full_content_files=None, top_n_files=3)
    ... # implementation

–§–∞–π–ª: sloth_cli.py
------------------
# File: sloth_cli.py
# Summary of declarations:

def calculate_cost(model_name, input_tokens, output_tokens)
    ... # implementation

def get_project_context(is_fast_mode, files_to_include_fully=None)
    ... # implementation

def _log_run(log_file_path, title, content)
    ... # implementation

def _read_multiline_input(prompt)
    ... # implementation

def get_user_input()
    ... # implementation

def extract_block(tag, text)
    ... # implementation

def update_history_with_attempt(history_file_path, goal, summary)
    ... # implementation

def load_fix_history(history_file_path)
    ... # implementation

def notify_user(message)
    ... # implementation

def cost_report(cost_log, total_cost)
    ... # implementation

def main(is_fix_mode, is_fast_mode, history_file_path, run_log_file_path)
    ... # implementation

–§–∞–π–ª: sloth_core.py
-------------------
# File: sloth_core.py
# Summary of declarations:

def initialize_model()
    ... # implementation

def get_active_service_details()
    ... # implementation

def send_request_to_model(model_instance, active_service, prompt_text, iteration_count=0)
    ... # implementation

def get_command_rules(stage='execution')
    ... # implementation

def get_clarification_and_planning_prompt(context, task)
    ... # implementation

def get_initial_prompt(context, task, fix_history=None)
    ... # implementation

def get_review_prompt(context, goal, iteration_count, attempt_history)
    ... # implementation

def get_error_fixing_prompt(failed_command, error_message, goal, context, iteration_count, attempt_history)
    ... # implementation

–§–∞–π–ª: sloth_runner.py
---------------------
# File: sloth_runner.py
# Summary of declarations:

def get_file_hash(filepath)
    ... # implementation

def execute_commands(commands_str)
    ... # implementation
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

--- –ó–ê–î–ê–ß–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
"‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø: –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –∑–∞—á–µ–º-—Ç–æ 
–º–æ–∂–µ–º –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏ –∏–∑–º–µ–Ω–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –ª–∏—à—å –µ–¥–∏–Ω–æ–∂–¥—ã –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ - —è –Ω–µ —Ö–æ—á—É —É—Ç–æ—á–Ω—è—Ç—å –ª–∏—à–Ω–µ–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–±–æ–ª—å—à–µ —Ñ–∞–π–ª–æ–≤ –∏ —Ä–∞–∑–±–µ—Ä–∏—Å—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ—á–µ–º—É —Ç–∞–∫ - —ç—Ç–æ –∫–æ–≥–¥–∞ –º—ã –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–æ–π –±–ª–æ–∫ –∏ –≤–æ—Ç –æ–Ω –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è
--- –ö–û–ù–ï–¶ –ó–ê–î–ê–ß–ò ---

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –°–ª–µ–¥—É–π –ø—Ä–∞–≤–∏–ª–∞–º —ç—Ç–∞–ø–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ª–∏–±–æ –∑–∞–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è (`clarification`), –ª–∏–±–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω (`plan`) –∏ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (`files`).


================================================================================
–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: PLANNING)
--------------------------------------------------------------------------------
```plan
1.  **–ê–Ω–∞–ª–∏–∑ `sloth_cli.py`**: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `main`. –ú–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–π—Ç–∏, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –Ø –±—É–¥—É –∏—Å–∫–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Ç–≤–µ—Ç –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–æ–∫ `manual`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø") –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å. –ï—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –∞ –∑–∞—Ç–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –±–ª–æ–∫ `manual` –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –¢–∞–∫–∂–µ —è –ø—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `notify_user`.
2.  **–ê–Ω–∞–ª–∏–∑ `sloth_core.py`**: –ò–∑—É—á—É —Ñ—É–Ω–∫—Ü–∏—é `send_request_to_model`, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ `sloth_cli.py`. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ, —Ö–æ—Ç—è —ç—Ç–æ –∏ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ.
3.  **–ê–Ω–∞–ª–∏–∑ `sloth_runner.py`**: –ü—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `execute_commands`. –•–æ—Ç—è –æ–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `bash`-–∫–æ–º–∞–Ω–¥, –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Ç–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ `manual`.
4.  **–í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –°–æ–ø–æ—Å—Ç–∞–≤–∏–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ñ–∞–π–ª–æ–≤, —è –æ—Ç—Å–ª–µ–∂—É –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ –∏ –Ω–∞–π–¥—É –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã `print` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞ –≤—ã–≤–æ–¥ –±–ª–æ–∫–∞ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø".
5.  **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ –≤ `sloth_cli.py`.
6.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ç—á–∞**: –Ø —Å–æ–∑–¥–∞–º `bash`-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `sed`.
```
```files
sloth_cli.py
sloth_core.py
sloth_runner.py
```

================================================================================
–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: EXECUTION, –ò—Ç–µ—Ä–∞—Ü–∏—è: 1)
--------------------------------------------------------------------------------

–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å shell-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ò–°–ü–û–õ–ù–ï–ù–ò–Ø:**

1.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ò–∑–º–µ–Ω–µ–Ω–∏–π:**
    *   **–¢–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ (`sed`):** –ò—Å–ø–æ–ª—å–∑—É–π `sed` **—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö** –∑–∞–º–µ–Ω.
    *   **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (`cat`):** –ò—Å–ø–æ–ª—å–∑—É–π `cat <<'EOF' > path/to/file.txt ... EOF` –¥–ª—è –ª—é–±—ã—Ö –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥.

2.  **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –§–∞–π–ª–æ–≤ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!):**
    *   **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cat` —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –ê–ö–ö–£–†–ê–¢–ï–ù. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π –≤ –±–ª–æ–∫ `EOF` **–ø–æ–ª–Ω–æ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    *   **–°—Ç—Ä–∞—Ç–µ–≥–∏—è "–û–¥–∏–Ω –∑–∞ —Ä–∞–∑":** –ï—Å–ª–∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω—è–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é**.

3.  **–§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞:**
    *   **–î–µ–π—Å—Ç–≤–∏—è:** –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥: ```bash ... ```.
        2.  –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ ‚Äî –±–ª–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ```summary ... ```.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞, –Ω–∞–ø–∏—à–∏ **—Ç–æ–ª—å–∫–æ** `–ì–û–¢–û–í–û`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ```done_summary ... ```. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `npm start`), –¥–æ–±–∞–≤—å –∏—Ö –≤ –±–ª–æ–∫ ```manual```.

**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `sed, rm, mv, touch, mkdir, npm, npx, yarn, pnpm, git, echo, ./, cat`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.



--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–ü–û–õ–ù–´–ô –ò–õ–ò –ß–ê–°–¢–ò–ß–ù–´–ô) ---
–°–µ–π—á–∞—Å —è –≤—ã–≥—Ä—É–∂—É –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞: —Å–Ω–∞—á–∞–ª–∞ –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –≤ —Å–∏–º–≤–æ–ª–∞—Ö, –∞ –ø–æ—Ç–æ–º –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

--- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ ---
lazy_develop/
‚îú‚îÄ‚îÄ colors.py (664 chars)
‚îú‚îÄ‚îÄ !!!context_collector.py (6540 chars)
‚îú‚îÄ‚îÄ !!!sloth_cli.py (17600 chars)
‚îú‚îÄ‚îÄ !!!sloth_core.py (13197 chars)
‚îú‚îÄ‚îÄ sloth_plan.txt (1480 chars)
‚îî‚îÄ‚îÄ sloth_runner.py (4141 chars)

--- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ ---

–§–∞–π–ª: colors.py
---------------
# File: colors.py
# Summary of declarations:

class Colors:
    ... # implementation

–§–∞–π–ª: context_collector.py
--------------------------
# File: context_collector.py
# Summary of declarations:

def _get_file_content(filepath)
    ... # implementation

def _summarize_content(content, filepath)
    ... # implementation

def _should_ignore(path, root_dir)
    ... # implementation

def gather_project_context(root_dir, mode='full', full_content_files=None, top_n_files=3)
    ... # implementation

–§–∞–π–ª: sloth_cli.py
------------------
# –§–∞–π–ª: sloth_cli.py
import os
import sys
import time
import re
import json
import platform
import subprocess
import argparse
from tkinter import Tk, filedialog

from colors import Colors
import sloth_core
import sloth_runner
import context_collector

# --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
MAX_ITERATIONS = 20
HISTORY_FILE_NAME = 'sloth_history.json'
RUN_LOG_FILE_NAME = 'sloth_run.log'

def calculate_cost(model_name, input_tokens, output_tokens):
    pricing_info = sloth_core.MODEL_PRICING.get(model_name)
    if not pricing_info: return 0.0
    total_cost = 0.0
    input_tiers = pricing_info.get("input", {}).get("tiers", [])
    for tier in input_tiers:
        if input_tokens <= tier["up_to"]:
            total_cost += (tier["price"] / 1_000_000) * input_tokens
            break
    output_tiers = pricing_info.get("output", {}).get("tiers", [])
    for tier in output_tiers:
        if input_tokens <= tier["up_to"]: 
            total_cost += (tier["price"] / 1_000_000) * output_tokens
            break
    return total_cost

def get_project_context(is_fast_mode, files_to_include_fully=None):
    print(f"{Colors.CYAN}üîÑ –õ–û–ì: –û–±–Ω–æ–≤–ª—è—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞...{Colors.ENDC}")
    try:
        if is_fast_mode:
            context_data = context_collector.gather_project_context(os.getcwd(), mode='full')
        else:
            mode = 'summarized'
            context_data = context_collector.gather_project_context(os.getcwd(), mode=mode, full_content_files=files_to_include_fully)
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω. –†–∞–∑–º–µ—Ä: {len(context_data)} —Å–∏–º–≤–æ–ª–æ–≤.{Colors.ENDC}")
        return context_data
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ get_project_context: {e}{Colors.ENDC}")
        return None

def _log_run(log_file_path, title, content):
    try:
        with open(log_file_path, 'a', encoding='utf-8') as f:
            f.write("\n" + "="*80 + "\n" + f"{title}\n" + "-"*80 + "\n")
            f.write(str(content if content is not None else "<empty>") + "\n")
    except Exception as e:
        print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ {log_file_path}: {e}{Colors.ENDC}")

def _read_multiline_input(prompt):
    print(prompt)
    lines = []
    empty_line_count = 0
    while empty_line_count < 3:
        try:
            line = input()
            if line: lines.append(line); empty_line_count = 0
            else: empty_line_count += 1
        except EOFError: break
    return '\n'.join(lines).strip()

def get_user_input():
    goal_prompt = (f"{Colors.HEADER}{Colors.BOLD}üëã –ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏ —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å.{Colors.ENDC}\n"
                   f"{Colors.CYAN}üí° (–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞, –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥){Colors.ENDC}")
    user_goal = _read_multiline_input(goal_prompt)
    if not user_goal: return None, None
    log_prompt = (f"\n{Colors.HEADER}{Colors.BOLD}üëç –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–≥ –æ—à–∏–±–∫–∏, –≤—Å—Ç–∞–≤—å –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞.{Colors.ENDC}")
    error_log = _read_multiline_input(log_prompt)
    return user_goal, error_log

def extract_block(tag, text):
    match = re.search(fr"```{tag}\s*(.*?)\s*```", text, re.DOTALL)
    return match.group(1).strip() if match else None

def update_history_with_attempt(history_file_path, goal, summary):
    try:
        with open(history_file_path, 'r+', encoding='utf-8') as f:
            history_data = json.load(f)
            new_entry = {"initial_goal": goal, "solution_summary": summary}
            history_data.setdefault("previous_attempts", []).insert(0, new_entry)
            f.seek(0); json.dump(history_data, f, indent=2, ensure_ascii=False); f.truncate()
        print(f"{Colors.OKGREEN}üíæ –õ–û–ì: –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ {history_file_path}.{Colors.ENDC}")
    except (IOError, json.JSONDecodeError) as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–µ—à–µ–Ω–∏—è: {e}{Colors.ENDC}")

def load_fix_history(history_file_path):
    if not os.path.exists(history_file_path): return None
    try:
        with open(history_file_path, 'r', encoding='utf-8') as f: history_data = json.load(f)
        attempts = history_data.get("previous_attempts", [])
        if not attempts: return None
        last_attempt = attempts[0]
        return (f"–≠—Ç–æ —Ç–≤–æ—è —Å–∞–º–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ–∫–∞–∑–∞–ª–∞—Å—å –Ω–µ–≤–µ—Ä–Ω–æ–π:\n"
                f"  - –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: {last_attempt.get('initial_goal', 'N/A')}\n"
                f"  - –¢–≤–æ–µ '—Ä–µ—à–µ–Ω–∏–µ': {last_attempt.get('solution_summary', 'N/A')}")
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ {history_file_path}: {e}{Colors.ENDC}")
        return None

def notify_user(message):
    clean_message = re.sub(r'\033\[.*?m', '', message)
    print(f"{Colors.OKBLUE}üì¢ –õ–û–ì: –û—Ç–ø—Ä–∞–≤–ª—è—é —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {message}{Colors.ENDC}")
    # ... (–∫–æ–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

def cost_report(cost_log, total_cost):
    print(f"\n{Colors.BOLD}{Colors.HEADER}--- –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –ü–û –°–¢–û–ò–ú–û–°–¢–ò ---{Colors.ENDC}")
    for entry in cost_log:
        phase, cost = entry['phase'], entry['cost']
        if phase == 'PLANNING':
            print(f"  –§–∞–∑–∞: {phase:<12} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost:.6f}")
        else:
            iteration = entry['iteration']
            print(f"  –§–∞–∑–∞: {phase:<12} | –ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration:<2} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost:.6f}")
    print(f"{Colors.BOLD}\n  –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–¥–∞—á–∏: ${total_cost:.6f}{Colors.ENDC}")

# --- –ì–õ–ê–í–ù–´–ô –£–ü–†–ê–í–õ–Ø–Æ–©–ò–ô –¶–ò–ö–õ ---
def main(is_fix_mode, is_fast_mode, history_file_path, run_log_file_path):
    sloth_core.initialize_model()
    model_instance, active_service = sloth_core.get_active_service_details()
    if not model_instance: return f"{Colors.FAIL}–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å. –í—ã—Ö–æ–¥.{Colors.ENDC}"

    total_cost, cost_log = 0.0, []
    user_goal, error_log = get_user_input()
    if not user_goal: return f"{Colors.WARNING}–¶–µ–ª—å –Ω–µ –±—ã–ª–∞ —É–∫–∞–∑–∞–Ω–∞. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.{Colors.ENDC}"
    initial_task = user_goal + (f"\n\n--- –õ–û–ì –û–®–ò–ë–ö–ò ---\n{error_log}" if error_log else "")
    
    attempt_history, final_message = [], ""
    state = "EXECUTION" if is_fast_mode else "PLANNING"
    iteration_count, files_to_include_fully, current_prompt = 1, None, None

    while iteration_count <= MAX_ITERATIONS:
        model_instance, active_service = sloth_core.get_active_service_details()

        # --- –≠–¢–ê–ü 1: –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï –ò –£–¢–û–ß–ù–ï–ù–ò–ï (–µ—Å–ª–∏ –Ω–µ –≤ --fast —Ä–µ–∂–∏–º–µ) ---
        if state == "PLANNING":
            print(f"\n{Colors.BOLD}{Colors.HEADER}--- –≠–¢–ê–ü: –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï ---{Colors.ENDC}")
            project_context = get_project_context(is_fast_mode=False, files_to_include_fully=None)
            if not project_context: return f"{Colors.FAIL}–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞.{Colors.ENDC}"
            
            prompt_for_planning = sloth_core.get_clarification_and_planning_prompt(project_context, initial_task)
            _log_run(run_log_file_path, f"–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state})", prompt_for_planning)
            answer_data = sloth_core.send_request_to_model(model_instance, active_service, prompt_for_planning)
            
            if not answer_data:
                if sloth_core.model: print(f"{Colors.WARNING}üîÑ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...{Colors.ENDC}"); time.sleep(5); continue
                else: final_message = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∏ –Ω–µ—Ç –∑–∞–ø–∞—Å–Ω–æ–≥–æ API."; break

            answer_text = answer_data["text"]
            _log_run(run_log_file_path, f"–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state})", answer_text)

            cost = calculate_cost(sloth_core.MODEL_NAME, answer_data["input_tokens"], answer_data["output_tokens"]); total_cost += cost
            cost_log.append({"phase": state, "iteration": 0, "cost": cost})
            print(f"{Colors.GREY}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Ö–æ–¥: {answer_data['input_tokens']} —Ç., –í—ã—Ö–æ–¥: {answer_data['output_tokens']} —Ç. –°—Ç–æ–∏–º–æ—Å—Ç—å: ~${cost:.6f}{Colors.ENDC}")

            clarification = extract_block("clarification", answer_text)
            if clarification:
                print(f"{Colors.HEADER}{Colors.BOLD}ü§ñ –ú–æ–¥–µ–ª—å –ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π:{Colors.ENDC}\n{Colors.CYAN}{clarification}{Colors.ENDC}")
                user_response = _read_multiline_input("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –º–æ–¥–µ–ª–∏. (Enter 3 —Ä–∞–∑–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)")
                initial_task += f"\n\n--- –£–¢–û–ß–ù–ï–ù–ò–ï –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---\n{user_response}"
                continue

            plan = extract_block("plan", answer_text); files_list_str = extract_block("files", answer_text)
            if plan and files_list_str:
                print(f"{Colors.OKGREEN}‚úÖ –ó–∞–¥–∞—á–∞ –ø–æ–Ω—è—Ç–Ω–∞. –ü–ª–∞–Ω –ø–æ–ª—É—á–µ–Ω.{Colors.ENDC}\n{Colors.HEADER}–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:{Colors.ENDC}\n{Colors.CYAN}{plan}{Colors.ENDC}")
                with open("sloth_plan.txt", "w", encoding='utf-8') as f: f.write(plan)
                print(f"{Colors.OKGREEN}–ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ 'sloth_plan.txt'.{Colors.ENDC}")
                
                files_to_include_fully = [line.strip() for line in files_list_str.split('\n') if line.strip()]
                print(f"{Colors.HEADER}–ó–∞–ø—Ä–æ—à–µ–Ω—ã –ø–æ–ª–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤:{Colors.ENDC}\n{Colors.CYAN}" + "\n".join(files_to_include_fully) + Colors.ENDC)
                state = "EXECUTION" # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                current_prompt = None # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç, —á—Ç–æ–±—ã –æ–Ω —Å–æ–∑–¥–∞–ª—Å—è –∑–∞–Ω–æ–≤–æ –Ω–∞ —ç—Ç–∞–ø–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
                continue
            else:
                print(f"{Colors.WARNING}‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –Ω–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π, –Ω–∏ –ø–ª–∞–Ω–∞. –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...{Colors.ENDC}"); time.sleep(5); continue

        # --- –≠–¢–ê–ü 2: –ò–°–ü–û–õ–ù–ï–ù–ò–ï ---
        if state == "EXECUTION":
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –≤ –Ω–∞—á–∞–ª–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            if current_prompt is None:
                project_context = get_project_context(is_fast_mode, files_to_include_fully)
                if not project_context: return f"{Colors.FAIL}–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.{Colors.ENDC}"
                current_prompt = sloth_core.get_initial_prompt(project_context, initial_task, load_fix_history(history_file_path) if is_fix_mode else None)
            
            print(f"\n{Colors.BOLD}{Colors.HEADER}üöÄ --- –≠–¢–ê–ü: –ò–°–ü–û–õ–ù–ï–ù–ò–ï | –ò–¢–ï–†–ê–¶–ò–Ø {iteration_count}/{MAX_ITERATIONS} ---{Colors.ENDC}")
            _log_run(run_log_file_path, f"–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state}, –ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration_count})", current_prompt)
            answer_data = sloth_core.send_request_to_model(model_instance, active_service, current_prompt, iteration_count)
            
            if not answer_data:
                if sloth_core.model: print(f"{Colors.WARNING}üîÑ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...{Colors.ENDC}"); time.sleep(5); continue
                else: final_message = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∏ –Ω–µ—Ç –∑–∞–ø–∞—Å–Ω–æ–≥–æ API."; break

            answer_text = answer_data["text"]
            _log_run(run_log_file_path, f"–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state}, –ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration_count})", answer_text)

            cost = calculate_cost(sloth_core.MODEL_NAME, answer_data["input_tokens"], answer_data["output_tokens"]); total_cost += cost
            cost_log.append({"phase": state, "iteration": iteration_count, "cost": cost})
            print(f"{Colors.GREY}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Ö–æ–¥: {answer_data['input_tokens']} —Ç., –í—ã—Ö–æ–¥: {answer_data['output_tokens']} —Ç. –°—Ç–æ–∏–º–æ—Å—Ç—å: ~${cost:.6f}{Colors.ENDC}")

            if extract_block("done_summary", answer_text) or answer_text.strip().upper().startswith("–ì–û–¢–û–í–û"):
                done_summary = extract_block("done_summary", answer_text) or "–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞."; final_message = f"{Colors.OKGREEN}‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! (–∑–∞ {iteration_count} –∏—Ç–µ—Ä–∞—Ü–∏–π){Colors.ENDC}"
                update_history_with_attempt(history_file_path, user_goal, done_summary)
                print(f"{Colors.OKGREEN}üìÑ –ò–¢–û–ì–û–í–û–ï –†–ï–ó–Æ–ú–ï:\n{Colors.CYAN}{done_summary}{Colors.ENDC}")
                manual_steps = extract_block("manual", answer_text)
                if manual_steps: final_message += f"\n\n{Colors.WARNING}‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:{Colors.ENDC}\n{manual_steps}"
                break

            commands_to_run = extract_block("bash", answer_text)
            if not commands_to_run:
                print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –æ—Ç–≤–µ—Ç –±–µ–∑ –∫–æ–º–∞–Ω–¥. –ü—Ä–æ–±—É—é –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.{Colors.ENDC}")
                project_context = get_project_context(is_fast_mode, files_to_include_fully)
                current_prompt = sloth_core.get_review_prompt(project_context, user_goal, iteration_count + 1, attempt_history)
                iteration_count += 1; continue

            strategy_description = extract_block("summary", answer_text) or "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –æ–ø–∏—Å–∞–Ω–∞"
            print(f"\n{Colors.OKBLUE}üîß –ù–∞–π–¥–µ–Ω –±–ª–æ–∫ shell-–∫–æ–º–∞–Ω–¥. –í—ã–ø–æ–ª–Ω—è—é...{Colors.ENDC}")
            success, failed_command, error_message = sloth_runner.execute_commands(commands_to_run)
            
            project_context = get_project_context(is_fast_mode, files_to_include_fully)
            if not project_context: final_message = f"{Colors.FAIL}–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç."; break

            history_entry = f"**–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}:**\n**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** {strategy_description}\n"
            if success:
                history_entry += "**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–°–ü–ï–•"
                current_prompt = sloth_core.get_review_prompt(project_context, user_goal, iteration_count + 1, attempt_history)
            else:
                history_entry += f"**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–†–û–í–ê–õ\n**–û—à–∏–±–∫–∞:** {error_message}"
                current_prompt = sloth_core.get_error_fixing_prompt(failed_command, error_message, user_goal, project_context, iteration_count + 1, attempt_history)
            
            attempt_history.append(history_entry)
            iteration_count += 1
    
    if not final_message: final_message = f"{Colors.WARNING}‚åõ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ {MAX_ITERATIONS} –∏—Ç–µ—Ä–∞—Ü–∏–π. –ó–∞–¥–∞—á–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.{Colors.ENDC}"
    cost_report(cost_log, total_cost)
    return final_message

# --- –¢–û–ß–ö–ê –í–•–û–î–ê ---
if __name__ == "__main__":
    # –ö–æ–¥ –≤ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
    SLOTH_SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
    parser = argparse.ArgumentParser(description="Sloth: AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–¥–∞.")
    parser.add_argument('--here', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è —Å --fix).')
    parser.add_argument('--fix', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∑–∏–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–µ—Å—Å–∏–∏.')
    parser.add_argument('--fast', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –±—ã—Å—Ç—Ä–æ–º —Ä–µ–∂–∏–º–µ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è —Å --fix).')
    args = parser.parse_args()

    history_file_path = os.path.join(SLOTH_SCRIPT_DIR, HISTORY_FILE_NAME)
    target_project_path, is_fast_mode = "", args.fast

    if args.fix:
        print(f"{Colors.CYAN}‚öôÔ∏è  –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º --fix. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ {history_file_path}...{Colors.ENDC}")
        if not os.path.exists(history_file_path): print(f"{Colors.FAIL}‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ {history_file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω.{Colors.ENDC}"); sys.exit(1)
        try:
            with open(history_file_path, 'r', encoding='utf-8') as f: config = json.load(f).get("last_run_config")
            target_project_path, is_fast_mode = config["target_project_path"], config["is_fast_mode"]
            print(f"{Colors.OKGREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–µ–∫—Ç: {target_project_path}, –†–µ–∂–∏–º: {'–ë—ã—Å—Ç—Ä—ã–π' if is_fast_mode else '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π'}.{Colors.ENDC}")
        except Exception as e: print(f"{Colors.FAIL}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: {e}{Colors.ENDC}"); sys.exit(1)
    else:
        if args.here: target_project_path = os.getcwd()
        else:
            print(f"{Colors.OKBLUE}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ...{Colors.ENDC}")
            root = Tk(); root.withdraw(); target_project_path = filedialog.askdirectory(title="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è Sloth"); root.destroy()
        if not target_project_path: print(f"{Colors.FAIL}–ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞.{Colors.ENDC}"); sys.exit(1)
        if os.path.exists(history_file_path): os.remove(history_file_path)
        initial_history = {"last_run_config": {"target_project_path": target_project_path, "is_fast_mode": is_fast_mode}, "previous_attempts": []}
        with open(history_file_path, 'w', encoding='utf-8') as f: json.dump(initial_history, f, indent=2, ensure_ascii=False)
        print(f"{Colors.CYAN}üíæ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {history_file_path}.{Colors.ENDC}")

    os.chdir(target_project_path)
    run_log_file_path = os.path.join(SLOTH_SCRIPT_DIR, RUN_LOG_FILE_NAME)
    try:
        with open(run_log_file_path, 'w', encoding='utf-8') as f: f.write(f"# SLOTH RUN LOG\n# –¶–µ–ª–µ–≤–æ–π –ø—Ä–æ–µ–∫—Ç: {target_project_path}\n# –†–µ–∂–∏–º: {'–ë—ã—Å—Ç—Ä—ã–π' if is_fast_mode else '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π'}\n")
    except Exception as e: print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å {run_log_file_path}: {e}{Colors.ENDC}")
    
    final_status = "–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
    try:
        final_status = main(is_fix_mode=args.fix, is_fast_mode=is_fast_mode, history_file_path=history_file_path, run_log_file_path=run_log_file_path)
    except KeyboardInterrupt: final_status = f"\n{Colors.OKBLUE}üîµ –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.{Colors.ENDC}"
    except Exception as e:
        import traceback; traceback.print_exc()
        final_status = f"\n{Colors.FAIL}‚ùå –°–∫—Ä–∏–ø—Ç –∞–≤–∞—Ä–∏–π–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è: {e}{Colors.ENDC}"
    finally:
        print(f"\n{final_status}"); notify_user(final_status); print(f"\n{Colors.BOLD}üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.{Colors.ENDC}")

–§–∞–π–ª: sloth_core.py
-------------------
# –§–∞–π–ª: sloth_core.py
import vertexai
from vertexai.generative_models import GenerativeModel, HarmCategory, HarmBlockThreshold
import google.generativeai as genai
import os
from colors import Colors

# --- –ù–ê–°–¢–†–û–ô–ö–ò –Ø–î–†–ê ---
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY", "REDACTED_GOOGLE_API_KEY")
GOOGLE_CLOUD_PROJECT = "useful-gearbox-464618-v3"
GOOGLE_CLOUD_LOCATION = "us-central1"
MODEL_NAME = "gemini-2.5-pro"
API_TIMEOUT_SECONDS = 600
ALLOWED_COMMANDS = (
    "sed", "rm", "mv", "touch", "mkdir", "npm", "npx", "yarn", "pnpm", "git", "echo", "./", "cat"
)

MODEL_PRICING = {
    "gemini-2.5-pro": {
        "input": {
            "tiers": [
                {"up_to": 200000, "price": 1.25},
                {"up_to": float('inf'), "price": 2.50}
            ]
        },
        "output": {
            "tiers": [
                {"up_to": 200000, "price": 10.00},
                {"up_to": float('inf'), "price": 15.00}
            ]
        }
    },
    "gemini-1.5-pro-latest": {
        "input": { "tiers": [{"up_to": float('inf'), "price": 3.50}] },
        "output": { "tiers": [{"up_to": float('inf'), "price": 10.50}] }
    }
}

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è API, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —è–¥—Ä–æ–º ---
model = None
ACTIVE_API_SERVICE = "N/A"
GOOGLE_AI_HAS_FAILED_THIS_SESSION = False

def initialize_model():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥–µ–ª—å Gemini."""
    global model, ACTIVE_API_SERVICE, GOOGLE_AI_HAS_FAILED_THIS_SESSION

    print(f"{Colors.CYAN}‚öôÔ∏è  –õ–û–ì: –ù–∞—á–∏–Ω–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –ú–æ–¥–µ–ª—å: {MODEL_NAME}{Colors.ENDC}")
    generation_config = {"temperature": 1, "top_p": 1, "top_k": 1, "max_output_tokens": 32768}

    if not GOOGLE_AI_HAS_FAILED_THIS_SESSION and GOOGLE_API_KEY:
        print(f"{Colors.CYAN}üîë –õ–û–ì: –ü—Ä–æ–±—É—é –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å: Google AI (API Key)...{Colors.ENDC}")
        try:
            genai.configure(api_key=GOOGLE_API_KEY)
            model = genai.GenerativeModel(
                model_name=MODEL_NAME,
                generation_config=generation_config,
                safety_settings={'HARM_CATEGORY_HARASSMENT': 'block_medium_and_above', 'HARM_CATEGORY_HATE_SPEECH': 'block_medium_and_above', 'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'block_medium_and_above', 'HARM_CATEGORY_DANGEROUS_CONTENT': 'block_none'}
            )
            model.generate_content("test", request_options={"timeout": 60})
            ACTIVE_API_SERVICE = "Google AI (API Key)"
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –£—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ {ACTIVE_API_SERVICE}.{Colors.ENDC}")
            return
        except Exception as e:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Google AI API Key: {e}{Colors.ENDC}")
            print(f"{Colors.CYAN}üîÑ –õ–û–ì: –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (Vertex AI)...{Colors.ENDC}")
            GOOGLE_AI_HAS_FAILED_THIS_SESSION = True
            model = None

    if GOOGLE_AI_HAS_FAILED_THIS_SESSION:
         print(f"{Colors.CYAN}üî© –õ–û–ì: –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Vertex AI...{Colors.ENDC}")
    else:
         print(f"{Colors.CYAN}üîë –õ–û–ì: API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É—é Vertex AI.{Colors.ENDC}")

    try:
        vertexai.init(project=GOOGLE_CLOUD_PROJECT, location=GOOGLE_CLOUD_LOCATION)
        model = GenerativeModel(
             model_name=MODEL_NAME,
             generation_config=generation_config,
             safety_settings={HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE}
        )
        ACTIVE_API_SERVICE = "Vertex AI"
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: Vertex AI SDK —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.{Colors.ENDC}")
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å: {e}{Colors.ENDC}")
        model = None
        ACTIVE_API_SERVICE = "N/A"

def get_active_service_details():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –∏ —Å–µ—Ä–≤–∏—Å –¥–ª—è CLI."""
    return model, ACTIVE_API_SERVICE

def send_request_to_model(model_instance, active_service, prompt_text, iteration_count=0):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–∫–µ–Ω–∞—Ö."""
    global GOOGLE_AI_HAS_FAILED_THIS_SESSION
    try:
        log_header = f"[–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}]" if iteration_count > 0 else "[–≠—Ç–∞–ø –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è]"
        print(f"{Colors.CYAN}üß† –õ–û–ì: {log_header} –ì–æ—Ç–æ–≤–ª—é –∑–∞–ø—Ä–æ—Å –≤ –º–æ–¥–µ–ª—å ({active_service}).{Colors.ENDC}")
        print(f"{Colors.CYAN}‚è≥ –õ–û–ì: –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å... (—Ç–∞–π–º–∞—É—Ç: {API_TIMEOUT_SECONDS} —Å–µ–∫){Colors.ENDC}")
        
        response = None
        if active_service == "Google AI (API Key)":
            request_options = {"timeout": API_TIMEOUT_SECONDS}
            response = model_instance.generate_content(prompt_text, request_options=request_options)
        elif active_service == "Vertex AI":
            response = model_instance.generate_content(prompt_text)
        else:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å API: {active_service}")
        
        if not response: 
            raise ValueError("–û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø—É—Å—Ç–æ–π.")
            
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ.{Colors.ENDC}")
        
        return {
            "text": response.text,
            "input_tokens": response.usage_metadata.prompt_token_count,
            "output_tokens": response.usage_metadata.candidates_token_count
        }
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API ({active_service}): {e}{Colors.ENDC}")
        error_str = str(e).lower()
        if active_service == "Google AI (API Key)" and ("quota" in error_str or "rate limit" in error_str):
            print(f"{Colors.FAIL}üö® –õ–û–ì: –û–ë–ù–ê–†–£–ñ–ï–ù–ê –û–®–ò–ë–ö–ê –ö–í–û–¢–´!{Colors.ENDC}")
            print(f"{Colors.CYAN}   - –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ (–Ω–∞ —ç—Ç—É —Å–µ—Å—Å–∏—é) –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ Vertex AI...{Colors.ENDC}")
            GOOGLE_AI_HAS_FAILED_THIS_SESSION = True
            initialize_model()
        return None

def get_command_rules(stage='execution'):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞ (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ).
    """
    base_rules = f"""
**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `{', '.join(ALLOWED_COMMANDS)}`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.
"""

    if stage == 'execution':
        return f"""
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å shell-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ò–°–ü–û–õ–ù–ï–ù–ò–Ø:**

1.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ò–∑–º–µ–Ω–µ–Ω–∏–π:**
    *   **–¢–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ (`sed`):** –ò—Å–ø–æ–ª—å–∑—É–π `sed` **—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö** –∑–∞–º–µ–Ω.
    *   **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (`cat`):** –ò—Å–ø–æ–ª—å–∑—É–π `cat <<'EOF' > path/to/file.txt ... EOF` –¥–ª—è –ª—é–±—ã—Ö –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥.

2.  **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –§–∞–π–ª–æ–≤ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!):**
    *   **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cat` —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –ê–ö–ö–£–†–ê–¢–ï–ù. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π –≤ –±–ª–æ–∫ `EOF` **–ø–æ–ª–Ω–æ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    *   **–°—Ç—Ä–∞—Ç–µ–≥–∏—è "–û–¥–∏–Ω –∑–∞ —Ä–∞–∑":** –ï—Å–ª–∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω—è–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é**.

3.  **–§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞:**
    *   **–î–µ–π—Å—Ç–≤–∏—è:** –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥: ```bash ... ```.
        2.  –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ ‚Äî –±–ª–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ```summary ... ```.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞, –Ω–∞–ø–∏—à–∏ **—Ç–æ–ª—å–∫–æ** `–ì–û–¢–û–í–û`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ```done_summary ... ```. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `npm start`), –¥–æ–±–∞–≤—å –∏—Ö –≤ –±–ª–æ–∫ ```manual```.
{base_rules}
"""

    if stage == 'planning':
        return f"""
–¢—ã ‚Äî AI-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. –¢–≤–æ—è –ø–µ—Ä–≤–∞—è –∏ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è—Ç–µ–Ω.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–Ø:**

1.  **–ê–Ω–∞–ª–∏–∑ –ó–∞–¥–∞—á–∏:** –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π **—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π** –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã).
2.  **–î–≤–∞ –ü—É—Ç–∏ –†–∞–∑–≤–∏—Ç–∏—è:**
    *   **–ü—É—Ç—å –ê: –ó–∞–¥–∞—á–∞ –ù–ï–ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ—á–µ—Ç–∫–æ, –Ω–µ–ø–æ–ª–Ω–æ –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–ª—å–∑—è –Ω–∞–π—Ç–∏ –≤ –∫–æ–¥–µ ‚Äî **–∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ** –±–ª–æ–∫ ```clarification ... ``` —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–ª–∞–Ω –∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π —Ñ–∞–π–ª—ã.
    *   **–ü—É—Ç—å –ë: –ó–∞–¥–∞—á–∞ –ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ —Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. –¢–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  **–ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π:** ```plan ... ```. –û–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–º.
        2.  **–°–ø–∏—Å–æ–∫ –§–∞–π–ª–æ–≤:** ```files ... ```. –ü–µ—Ä–µ—á–∏—Å–ª–∏ **–≤—Å–µ** —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ, –ø–æ —Ç–≤–æ–µ–º—É –º–Ω–µ–Ω–∏—é, –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞. –£–∫–∞–∑—ã–≤–∞–π –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ. –ù–µ —ç–∫–æ–Ω–æ–º—å! –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –∫–∞—á–µ—Å—Ç–≤–æ - –∑–∞–ø—Ä–æ—Å–∏ –≤—Å–µ —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–ª–∏ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è!!! –≠—Ç–æ –≤–∞–∂–Ω–æ - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ö–ê–ß–ï–°–¢–í–û!
3.  **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ **–ó–ê–ü–†–ï–©–ï–ù–û** –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ```bash``` –∏–ª–∏ ```summary```. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ª–∏–±–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ª–∏–±–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∞–π–ª—ã.
{base_rules}
"""

def get_clarification_and_planning_prompt(context, task):
    """
    –ù–û–í–´–ô –ü–†–û–ú–ü–¢: –î–ª—è —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –≤ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.
    """
    rules = get_command_rules(stage='planning')
    return f"""{rules}

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–°–û–ö–†–ê–©–ï–ù–ù–´–ô) ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

--- –ó–ê–î–ê–ß–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
{task}
--- –ö–û–ù–ï–¶ –ó–ê–î–ê–ß–ò ---

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –°–ª–µ–¥—É–π –ø—Ä–∞–≤–∏–ª–∞–º —ç—Ç–∞–ø–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ª–∏–±–æ –∑–∞–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è (`clarification`), –ª–∏–±–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω (`plan`) –∏ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (`files`).
"""

def get_initial_prompt(context, task, fix_history=None):
    """
    –≠—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞ **—ç—Ç–∞–ø–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è**.
    """
    history_prompt_section = ""
    if fix_history:
        history_prompt_section = f"""
--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ï–ì–û –†–ï–®–ï–ù–ò–Ø, –ö–û–¢–û–†–û–ï –û–ö–ê–ó–ê–õ–û–°–¨ –ù–ï–í–ï–†–ù–´–ú ---
{fix_history}
--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–≤–æ—é –ø—Ä–æ—à–ª—É—é –æ—à–∏–±–∫—É –∏ –Ω–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ.
"""
    return f"{get_command_rules(stage='execution')}\n{history_prompt_section}\n--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–ü–û–õ–ù–´–ô –ò–õ–ò –ß–ê–°–¢–ò–ß–ù–´–ô) ---\n{context}\n--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---\n–ó–∞–¥–∞—á–∞: {task}\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –æ—Ç–≤–µ—Ç, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è."

def get_review_prompt(context, goal, iteration_count, attempt_history):
    iteration_info = ""
    if iteration_count >= 4:
        iteration_info = f"\n**–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}):** –¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ.\n"
    history_info = ""
    if attempt_history:
        history_info = (
            "--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---\n" +
            "\n---\n".join(attempt_history) +
            "\n--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---\n"
        )
    return f"""{get_command_rules(stage='execution')}
{iteration_info}
{history_info}
**–í–ê–ñ–ù–û:** –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–æ–¥ –Ω–∏–∂–µ ‚Äî —ç—Ç–æ **–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** –ø—Ä–æ–µ–∫—Ç–∞.

**–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø:**
1.  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â–∏–π** –∫–æ–¥, —É—á–∏—Ç—ã–≤–∞—è **–≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**.
2.  –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –Ω–∞–ø–∏—à–∏ `–ì–û–¢–û–í–û`.
3.  –ï—Å–ª–∏ —Ü–µ–ª—å –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

–ù–∞–ø–æ–º–∏–Ω–∞—é –ò–°–•–û–î–ù–£–Æ –¶–ï–õ–¨: {goal}
"""

def get_error_fixing_prompt(failed_command, error_message, goal, context, iteration_count, attempt_history):
    iteration_info = ""
    if iteration_count >= 4:
        iteration_info = f"\n**–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}):** –¢—ã —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤, –∏ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ.\n"
    history_info = ""
    if attempt_history:
        history_info = (
            "--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---\n" +
            "\n---\n".join(attempt_history) +
            "\n--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---\n"
        )
    return f"""{get_command_rules(stage='execution')}
{iteration_info}
{history_info}
**–í–ê–ñ–ù–û:** –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞. –ù–µ –ø–∏—à–∏ '–ì–û–¢–û–í–û'.

--- –î–ê–ù–ù–´–ï –û –¢–ï–ö–£–©–ï–ô –û–®–ò–ë–ö–ï ---
–ö–û–ú–ê–ù–î–ê: {failed_command}
–°–û–û–ë–©–ï–ù–ò–ï (stderr): {error_message}
--- –ö–û–ù–ï–¶ –î–ê–ù–ù–´–• –û–ë –û–®–ò–ë–ö–ï ---

–ò—Å—Ö–æ–¥–Ω–∞—è –¶–ï–õ–¨ –±—ã–ª–∞: {goal}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â—É—é –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏** –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å **–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥** –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢, –ì–î–ï –ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---
"""

–§–∞–π–ª: sloth_plan.txt
--------------------
1.  **–ê–Ω–∞–ª–∏–∑ `sloth_cli.py`**: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `main`. –ú–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–π—Ç–∏, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –Ø –±—É–¥—É –∏—Å–∫–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Ç–≤–µ—Ç –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–æ–∫ `manual`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø") –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å. –ï—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –∞ –∑–∞—Ç–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –±–ª–æ–∫ `manual` –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –¢–∞–∫–∂–µ —è –ø—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `notify_user`.
2.  **–ê–Ω–∞–ª–∏–∑ `sloth_core.py`**: –ò–∑—É—á—É —Ñ—É–Ω–∫—Ü–∏—é `send_request_to_model`, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ `sloth_cli.py`. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ, —Ö–æ—Ç—è —ç—Ç–æ –∏ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ.
3.  **–ê–Ω–∞–ª–∏–∑ `sloth_runner.py`**: –ü—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `execute_commands`. –•–æ—Ç—è –æ–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `bash`-–∫–æ–º–∞–Ω–¥, –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Ç–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ `manual`.
4.  **–í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –°–æ–ø–æ—Å—Ç–∞–≤–∏–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ñ–∞–π–ª–æ–≤, —è –æ—Ç—Å–ª–µ–∂—É –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ –∏ –Ω–∞–π–¥—É –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã `print` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞ –≤—ã–≤–æ–¥ –±–ª–æ–∫–∞ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø".
5.  **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ –≤ `sloth_cli.py`.
6.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ç—á–∞**: –Ø —Å–æ–∑–¥–∞–º `bash`-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `sed`.

–§–∞–π–ª: sloth_runner.py
---------------------
# –§–∞–π–ª: sloth_runner.py
import subprocess
import platform
import re
import hashlib
import os
from colors import Colors

def get_file_hash(filepath):
    """–í—ã—á–∏—Å–ª—è–µ—Ç SHA256 —Ö—ç—à —Ñ–∞–π–ª–∞."""
    if not os.path.exists(filepath) or os.path.isdir(filepath): return None
    h = hashlib.sha256()
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(8192)
            if not chunk: break
            h.update(chunk)
    return h.hexdigest()

def execute_commands(commands_str):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–ª–æ–∫ shell-–∫–æ–º–∞–Ω–¥.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂: (success, failed_command, error_message)
    """
    print(f"{Colors.OKBLUE}  [–î–µ—Ç–∞–ª–∏] –ó–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞ –∫–æ–º–∞–Ω–¥...{Colors.ENDC}")

    # –ò–ó–ú–ï–ù–ï–ù–û: –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–∏—Å–∫–∞ –ø—É—Ç–µ–π, –≤–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    filepaths = re.findall(r'[\'"]?([a-zA-Z0-9_\-\.\/]+)[\'"]?', commands_str)
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
    hashes_before = {fp: get_file_hash(fp) for fp in filepaths if os.path.isfile(fp)}
    dirs_before = {fp for fp in filepaths if os.path.isdir(fp)}
    files_before = {fp for fp in filepaths if os.path.exists(fp)} # –í—Å–µ –ø—É—Ç–∏, –≤–∫–ª—é—á–∞—è –ø–∞–ø–∫–∏
    
    try:
        is_macos = platform.system() == "Darwin"
        # –î–ª—è macOS –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ .bak –¥–ª—è sed -i, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ –≤ Linux
        commands_str_adapted = re.sub(r"sed -i ", "sed -i '.bak' ", commands_str) if is_macos else commands_str
        full_command = f"set -e\n{commands_str_adapted}"

        print(f"{Colors.WARNING}‚ö°Ô∏è –õ–û–ì: –í—ã–ø–æ–ª–Ω—è—é –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ (bash, set -e)...{Colors.ENDC}")
        result = subprocess.run(['bash', '-c', full_command], capture_output=True, text=True, encoding='utf-8')

        if result.returncode != 0:
            error_msg = f"–ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞ ({result.returncode}).\n–û—à–∏–±–∫–∞ (STDERR): {result.stderr.strip()}"
            print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–ª–æ–∫–∞ –∫–æ–º–∞–Ω–¥.\n{error_msg}{Colors.ENDC}")
            return False, commands_str, result.stderr.strip() or "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å –±–µ–∑ –≤—ã–≤–æ–¥–∞ –≤ stderr."

        if result.stderr:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (STDERR –æ—Ç —É—Å–ø–µ—à–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã):\n{result.stderr.strip()}{Colors.ENDC}")

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã .bak, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ sed –Ω–∞ macOS
        if is_macos:
            subprocess.run("find . -name '*.bak' -delete", shell=True, check=True, capture_output=True)

        # --- –ù–û–í–ê–Ø, –ë–û–õ–ï–ï –ù–ê–î–ï–ñ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        hashes_after = {fp: get_file_hash(fp) for fp in hashes_before.keys()}
        files_after = {fp for fp in filepaths if os.path.exists(fp)}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ö—ç—à —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
        modified_files = any(hashes_before.get(fp) != hashes_after.get(fp) for fp in hashes_before)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–∞–ø–∫–∏
        created_paths = files_after - files_before
        
        if not modified_files and not created_paths:
            # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ –Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å - —ç—Ç–æ –æ—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏
            error_msg = ("–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞ –∏ –Ω–µ —Å–æ–∑–¥–∞–ª–∞ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏. "
                         "–í–µ—Ä–æ—è—Ç–Ω–æ, —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ sed) –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–µ–≤–µ—Ä–µ–Ω.")
            final_error_message = result.stderr.strip() if result.stderr else error_msg
            print(f"{Colors.FAIL}‚ùå –õ–û–ì: –û–®–ò–ë–ö–ê –õ–û–ì–ò–ö–ò: {error_msg}{Colors.ENDC}")
            if result.stderr:
                print(f"–ü—Ä–∏—á–∏–Ω–∞ –∏–∑ STDERR: {final_error_message}")
            return False, commands_str, final_error_message

        # –ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è, –≤—Å–µ —Ö–æ—Ä–æ—à–æ
        if modified_files:
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –§–∞–π–ª—ã –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã.{Colors.ENDC}")
        if created_paths:
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ –ø—É—Ç–∏: {', '.join(created_paths)}{Colors.ENDC}")
            
        return True, None, None

    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –û–®–ò–ë–ö–ê –≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ: {e}{Colors.ENDC}")
        return False, commands_str, str(e)
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---
–ó–∞–¥–∞—á–∞: "‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø: –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –∑–∞—á–µ–º-—Ç–æ 
–º–æ–∂–µ–º –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏ –∏–∑–º–µ–Ω–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –ª–∏—à—å –µ–¥–∏–Ω–æ–∂–¥—ã –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ - —è –Ω–µ —Ö–æ—á—É —É—Ç–æ—á–Ω—è—Ç—å –ª–∏—à–Ω–µ–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–±–æ–ª—å—à–µ —Ñ–∞–π–ª–æ–≤ –∏ —Ä–∞–∑–±–µ—Ä–∏—Å—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ—á–µ–º—É —Ç–∞–∫ - —ç—Ç–æ –∫–æ–≥–¥–∞ –º—ã –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–æ–π –±–ª–æ–∫ –∏ –≤–æ—Ç –æ–Ω –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –æ—Ç–≤–µ—Ç, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.

================================================================================
–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: EXECUTION, –ò—Ç–µ—Ä–∞—Ü–∏—è: 1)
--------------------------------------------------------------------------------
```bash
cat <<'EOF' > sloth_cli.py
# –§–∞–π–ª: sloth_cli.py
import os
import sys
import time
import re
import json
import platform
import subprocess
import argparse
from tkinter import Tk, filedialog

from colors import Colors
import sloth_core
import sloth_runner
import context_collector

# --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
MAX_ITERATIONS = 20
HISTORY_FILE_NAME = 'sloth_history.json'
RUN_LOG_FILE_NAME = 'sloth_run.log'

def calculate_cost(model_name, input_tokens, output_tokens):
    pricing_info = sloth_core.MODEL_PRICING.get(model_name)
    if not pricing_info: return 0.0
    total_cost = 0.0
    input_tiers = pricing_info.get("input", {}).get("tiers", [])
    for tier in input_tiers:
        if input_tokens <= tier["up_to"]:
            total_cost += (tier["price"] / 1_000_000) * input_tokens
            break
    output_tiers = pricing_info.get("output", {}).get("tiers", [])
    for tier in output_tiers:
        if input_tokens <= tier["up_to"]: 
            total_cost += (tier["price"] / 1_000_000) * output_tokens
            break
    return total_cost

def get_project_context(is_fast_mode, files_to_include_fully=None):
    print(f"{Colors.CYAN}üîÑ –õ–û–ì: –û–±–Ω–æ–≤–ª—è—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞...{Colors.ENDC}")
    try:
        if is_fast_mode:
            context_data = context_collector.gather_project_context(os.getcwd(), mode='full')
        else:
            mode = 'summarized'
            context_data = context_collector.gather_project_context(os.getcwd(), mode=mode, full_content_files=files_to_include_fully)
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω. –†–∞–∑–º–µ—Ä: {len(context_data)} —Å–∏–º–≤–æ–ª–æ–≤.{Colors.ENDC}")
        return context_data
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ get_project_context: {e}{Colors.ENDC}")
        return None

def _log_run(log_file_path, title, content):
    try:
        with open(log_file_path, 'a', encoding='utf-8') as f:
            f.write("\n" + "="*80 + "\n" + f"{title}\n" + "-"*80 + "\n")
            f.write(str(content if content is not None else "<empty>") + "\n")
    except Exception as e:
        print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ {log_file_path}: {e}{Colors.ENDC}")

def _read_multiline_input(prompt):
    print(prompt)
    lines = []
    empty_line_count = 0
    while empty_line_count < 3:
        try:
            line = input()
            if line: lines.append(line); empty_line_count = 0
            else: empty_line_count += 1
        except EOFError: break
    return '\n'.join(lines).strip()

def get_user_input():
    goal_prompt = (f"{Colors.HEADER}{Colors.BOLD}üëã –ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏ —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å.{Colors.ENDC}\n"
                   f"{Colors.CYAN}üí° (–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞, –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥){Colors.ENDC}")
    user_goal = _read_multiline_input(goal_prompt)
    if not user_goal: return None, None
    log_prompt = (f"\n{Colors.HEADER}{Colors.BOLD}üëç –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–≥ –æ—à–∏–±–∫–∏, –≤—Å—Ç–∞–≤—å –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞.{Colors.ENDC}")
    error_log = _read_multiline_input(log_prompt)
    return user_goal, error_log

def extract_block(tag, text):
    match = re.search(fr"```{tag}\s*(.*?)\s*```", text, re.DOTALL)
    return match.group(1).strip() if match else None

def update_history_with_attempt(history_file_path, goal, summary):
    try:
        with open(history_file_path, 'r+', encoding='utf-8') as f:
            history_data = json.load(f)
            new_entry = {"initial_goal": goal, "solution_summary": summary}
            history_data.setdefault("previous_attempts", []).insert(0, new_entry)
            f.seek(0); json.dump(history_data, f, indent=2, ensure_ascii=False); f.truncate()
        print(f"{Colors.OKGREEN}üíæ –õ–û–ì: –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ {history_file_path}.{Colors.ENDC}")
    except (IOError, json.JSONDecodeError) as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–µ—à–µ–Ω–∏—è: {e}{Colors.ENDC}")

def load_fix_history(history_file_path):
    if not os.path.exists(history_file_path): return None
    try:
        with open(history_file_path, 'r', encoding='utf-8') as f: history_data = json.load(f)
        attempts = history_data.get("previous_attempts", [])
        if not attempts: return None
        last_attempt = attempts[0]
        return (f"–≠—Ç–æ —Ç–≤–æ—è —Å–∞–º–∞—è –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ–∫–∞–∑–∞–ª–∞—Å—å –Ω–µ–≤–µ—Ä–Ω–æ–π:\n"
                f"  - –ü–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞: {last_attempt.get('initial_goal', 'N/A')}\n"
                f"  - –¢–≤–æ–µ '—Ä–µ—à–µ–Ω–∏–µ': {last_attempt.get('solution_summary', 'N/A')}")
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ {history_file_path}: {e}{Colors.ENDC}")
        return None

def notify_user(message):
    clean_message = re.sub(r'\033\[.*?m', '', message)
    print(f"{Colors.OKBLUE}üì¢ –õ–û–ì: –û—Ç–ø—Ä–∞–≤–ª—è—é –∏—Ç–æ–≥–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...{Colors.ENDC}")
    # ... (–∫–æ–¥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

def cost_report(cost_log, total_cost):
    print(f"\n{Colors.BOLD}{Colors.HEADER}--- –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –ü–û –°–¢–û–ò–ú–û–°–¢–ò ---{Colors.ENDC}")
    for entry in cost_log:
        phase, cost = entry['phase'], entry['cost']
        if phase == 'PLANNING':
            print(f"  –§–∞–∑–∞: {phase:<12} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost:.6f}")
        else:
            iteration = entry['iteration']
            print(f"  –§–∞–∑–∞: {phase:<12} | –ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration:<2} | –°—Ç–æ–∏–º–æ—Å—Ç—å: ${cost:.6f}")
    print(f"{Colors.BOLD}\n  –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–¥–∞—á–∏: ${total_cost:.6f}{Colors.ENDC}")

# --- –ì–õ–ê–í–ù–´–ô –£–ü–†–ê–í–õ–Ø–Æ–©–ò–ô –¶–ò–ö–õ ---
def main(is_fix_mode, is_fast_mode, history_file_path, run_log_file_path):
    sloth_core.initialize_model()
    model_instance, active_service = sloth_core.get_active_service_details()
    if not model_instance: return f"{Colors.FAIL}–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å. –í—ã—Ö–æ–¥.{Colors.ENDC}"

    total_cost, cost_log = 0.0, []
    user_goal, error_log = get_user_input()
    if not user_goal: return f"{Colors.WARNING}–¶–µ–ª—å –Ω–µ –±—ã–ª–∞ —É–∫–∞–∑–∞–Ω–∞. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.{Colors.ENDC}"
    initial_task = user_goal + (f"\n\n--- –õ–û–ì –û–®–ò–ë–ö–ò ---\n{error_log}" if error_log else "")
    
    attempt_history, final_message = [], ""
    state = "EXECUTION" if is_fast_mode else "PLANNING"
    iteration_count, files_to_include_fully, current_prompt = 1, None, None

    while iteration_count <= MAX_ITERATIONS:
        model_instance, active_service = sloth_core.get_active_service_details()

        # --- –≠–¢–ê–ü 1: –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï –ò –£–¢–û–ß–ù–ï–ù–ò–ï (–µ—Å–ª–∏ –Ω–µ –≤ --fast —Ä–µ–∂–∏–º–µ) ---
        if state == "PLANNING":
            print(f"\n{Colors.BOLD}{Colors.HEADER}--- –≠–¢–ê–ü: –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï ---{Colors.ENDC}")
            project_context = get_project_context(is_fast_mode=False, files_to_include_fully=None)
            if not project_context: return f"{Colors.FAIL}–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞.{Colors.ENDC}"
            
            prompt_for_planning = sloth_core.get_clarification_and_planning_prompt(project_context, initial_task)
            _log_run(run_log_file_path, f"–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state})", prompt_for_planning)
            answer_data = sloth_core.send_request_to_model(model_instance, active_service, prompt_for_planning)
            
            if not answer_data:
                if sloth_core.model: print(f"{Colors.WARNING}üîÑ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...{Colors.ENDC}"); time.sleep(5); continue
                else: final_message = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∏ –Ω–µ—Ç –∑–∞–ø–∞—Å–Ω–æ–≥–æ API."; break

            answer_text = answer_data["text"]
            _log_run(run_log_file_path, f"–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state})", answer_text)

            cost = calculate_cost(sloth_core.MODEL_NAME, answer_data["input_tokens"], answer_data["output_tokens"]); total_cost += cost
            cost_log.append({"phase": state, "iteration": 0, "cost": cost})
            print(f"{Colors.GREY}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Ö–æ–¥: {answer_data['input_tokens']} —Ç., –í—ã—Ö–æ–¥: {answer_data['output_tokens']} —Ç. –°—Ç–æ–∏–º–æ—Å—Ç—å: ~${cost:.6f}{Colors.ENDC}")

            clarification = extract_block("clarification", answer_text)
            if clarification:
                print(f"{Colors.HEADER}{Colors.BOLD}ü§ñ –ú–æ–¥–µ–ª—å –ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–µ–Ω–∏–π:{Colors.ENDC}\n{Colors.CYAN}{clarification}{Colors.ENDC}")
                user_response = _read_multiline_input("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –º–æ–¥–µ–ª–∏. (Enter 3 —Ä–∞–∑–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)")
                initial_task += f"\n\n--- –£–¢–û–ß–ù–ï–ù–ò–ï –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---\n{user_response}"
                continue

            plan = extract_block("plan", answer_text); files_list_str = extract_block("files", answer_text)
            if plan and files_list_str:
                print(f"{Colors.OKGREEN}‚úÖ –ó–∞–¥–∞—á–∞ –ø–æ–Ω—è—Ç–Ω–∞. –ü–ª–∞–Ω –ø–æ–ª—É—á–µ–Ω.{Colors.ENDC}\n{Colors.HEADER}–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:{Colors.ENDC}\n{Colors.CYAN}{plan}{Colors.ENDC}")
                with open("sloth_plan.txt", "w", encoding='utf-8') as f: f.write(plan)
                print(f"{Colors.OKGREEN}–ü–ª–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ 'sloth_plan.txt'.{Colors.ENDC}")
                
                files_to_include_fully = [line.strip() for line in files_list_str.split('\n') if line.strip()]
                print(f"{Colors.HEADER}–ó–∞–ø—Ä–æ—à–µ–Ω—ã –ø–æ–ª–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤:{Colors.ENDC}\n{Colors.CYAN}" + "\n".join(files_to_include_fully) + Colors.ENDC)
                state = "EXECUTION" # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                current_prompt = None # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç, —á—Ç–æ–±—ã –æ–Ω —Å–æ–∑–¥–∞–ª—Å—è –∑–∞–Ω–æ–≤–æ –Ω–∞ —ç—Ç–∞–ø–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
                continue
            else:
                print(f"{Colors.WARNING}‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ –Ω–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–π, –Ω–∏ –ø–ª–∞–Ω–∞. –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞...{Colors.ENDC}"); time.sleep(5); continue

        # --- –≠–¢–ê–ü 2: –ò–°–ü–û–õ–ù–ï–ù–ò–ï ---
        if state == "EXECUTION":
            # –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –≤ –Ω–∞—á–∞–ª–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
            if current_prompt is None:
                project_context = get_project_context(is_fast_mode, files_to_include_fully)
                if not project_context: return f"{Colors.FAIL}–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.{Colors.ENDC}"
                current_prompt = sloth_core.get_initial_prompt(project_context, initial_task, load_fix_history(history_file_path) if is_fix_mode else None)
            
            print(f"\n{Colors.BOLD}{Colors.HEADER}üöÄ --- –≠–¢–ê–ü: –ò–°–ü–û–õ–ù–ï–ù–ò–ï | –ò–¢–ï–†–ê–¶–ò–Ø {iteration_count}/{MAX_ITERATIONS} ---{Colors.ENDC}")
            _log_run(run_log_file_path, f"–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state}, –ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration_count})", current_prompt)
            answer_data = sloth_core.send_request_to_model(model_instance, active_service, current_prompt, iteration_count)
            
            if not answer_data:
                if sloth_core.model: print(f"{Colors.WARNING}üîÑ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–µ–Ω, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...{Colors.ENDC}"); time.sleep(5); continue
                else: final_message = "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –∏ –Ω–µ—Ç –∑–∞–ø–∞—Å–Ω–æ–≥–æ API."; break

            answer_text = answer_data["text"]
            _log_run(run_log_file_path, f"–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: {state}, –ò—Ç–µ—Ä–∞—Ü–∏—è: {iteration_count})", answer_text)

            cost = calculate_cost(sloth_core.MODEL_NAME, answer_data["input_tokens"], answer_data["output_tokens"]); total_cost += cost
            cost_log.append({"phase": state, "iteration": iteration_count, "cost": cost})
            print(f"{Colors.GREY}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—Ö–æ–¥: {answer_data['input_tokens']} —Ç., –í—ã—Ö–æ–¥: {answer_data['output_tokens']} —Ç. –°—Ç–æ–∏–º–æ—Å—Ç—å: ~${cost:.6f}{Colors.ENDC}")

            if extract_block("done_summary", answer_text) or answer_text.strip().upper().startswith("–ì–û–¢–û–í–û"):
                done_summary = extract_block("done_summary", answer_text) or "–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞."; final_message = f"{Colors.OKGREEN}‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! (–∑–∞ {iteration_count} –∏—Ç–µ—Ä–∞—Ü–∏–π){Colors.ENDC}"
                update_history_with_attempt(history_file_path, user_goal, done_summary)
                print(f"{Colors.OKGREEN}üìÑ –ò–¢–û–ì–û–í–û–ï –†–ï–ó–Æ–ú–ï:\n{Colors.CYAN}{done_summary}{Colors.ENDC}")
                manual_steps = extract_block("manual", answer_text)
                if manual_steps: final_message += f"\n\n{Colors.WARNING}‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:{Colors.ENDC}\n{manual_steps}"
                break

            commands_to_run = extract_block("bash", answer_text)
            if not commands_to_run:
                print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –æ—Ç–≤–µ—Ç –±–µ–∑ –∫–æ–º–∞–Ω–¥. –ü—Ä–æ–±—É—é –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.{Colors.ENDC}")
                project_context = get_project_context(is_fast_mode, files_to_include_fully)
                current_prompt = sloth_core.get_review_prompt(project_context, user_goal, iteration_count + 1, attempt_history)
                iteration_count += 1; continue

            strategy_description = extract_block("summary", answer_text) or "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –æ–ø–∏—Å–∞–Ω–∞"
            print(f"\n{Colors.OKBLUE}üîß –ù–∞–π–¥–µ–Ω –±–ª–æ–∫ shell-–∫–æ–º–∞–Ω–¥. –í—ã–ø–æ–ª–Ω—è—é...{Colors.ENDC}")
            success, failed_command, error_message = sloth_runner.execute_commands(commands_to_run)
            
            project_context = get_project_context(is_fast_mode, files_to_include_fully)
            if not project_context: final_message = f"{Colors.FAIL}–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç."; break

            history_entry = f"**–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}:**\n**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** {strategy_description}\n"
            if success:
                history_entry += "**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–°–ü–ï–•"
                current_prompt = sloth_core.get_review_prompt(project_context, user_goal, iteration_count + 1, attempt_history)
            else:
                history_entry += f"**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–†–û–í–ê–õ\n**–û—à–∏–±–∫–∞:** {error_message}"
                current_prompt = sloth_core.get_error_fixing_prompt(failed_command, error_message, user_goal, project_context, iteration_count + 1, attempt_history)
            
            attempt_history.append(history_entry)
            iteration_count += 1
    
    if not final_message: final_message = f"{Colors.WARNING}‚åõ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ {MAX_ITERATIONS} –∏—Ç–µ—Ä–∞—Ü–∏–π. –ó–∞–¥–∞—á–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.{Colors.ENDC}"
    cost_report(cost_log, total_cost)
    return final_message

# --- –¢–û–ß–ö–ê –í–•–û–î–ê ---
if __name__ == "__main__":
    # –ö–æ–¥ –≤ —ç—Ç–æ–π —Å–µ–∫—Ü–∏–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
    SLOTH_SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
    parser = argparse.ArgumentParser(description="Sloth: AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–¥–∞.")
    parser.add_argument('--here', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è —Å --fix).')
    parser.add_argument('--fix', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∑–∏–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–µ—Å—Å–∏–∏.')
    parser.add_argument('--fast', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ –±—ã—Å—Ç—Ä–æ–º —Ä–µ–∂–∏–º–µ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è —Å --fix).')
    args = parser.parse_args()

    history_file_path = os.path.join(SLOTH_SCRIPT_DIR, HISTORY_FILE_NAME)
    target_project_path, is_fast_mode = "", args.fast

    if args.fix:
        print(f"{Colors.CYAN}‚öôÔ∏è  –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∂–∏–º --fix. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ {history_file_path}...{Colors.ENDC}")
        if not os.path.exists(history_file_path): print(f"{Colors.FAIL}‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ {history_file_path} –Ω–µ –Ω–∞–π–¥–µ–Ω.{Colors.ENDC}"); sys.exit(1)
        try:
            with open(history_file_path, 'r', encoding='utf-8') as f: config = json.load(f).get("last_run_config")
            target_project_path, is_fast_mode = config["target_project_path"], config["is_fast_mode"]
            print(f"{Colors.OKGREEN}‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü—Ä–æ–µ–∫—Ç: {target_project_path}, –†–µ–∂–∏–º: {'–ë—ã—Å—Ç—Ä—ã–π' if is_fast_mode else '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π'}.{Colors.ENDC}")
        except Exception as e: print(f"{Colors.FAIL}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: {e}{Colors.ENDC}"); sys.exit(1)
    else:
        if args.here: target_project_path = os.getcwd()
        else:
            print(f"{Colors.OKBLUE}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ...{Colors.ENDC}")
            root = Tk(); root.withdraw(); target_project_path = filedialog.askdirectory(title="–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è Sloth"); root.destroy()
        if not target_project_path: print(f"{Colors.FAIL}–ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞.{Colors.ENDC}"); sys.exit(1)
        if os.path.exists(history_file_path): os.remove(history_file_path)
        initial_history = {"last_run_config": {"target_project_path": target_project_path, "is_fast_mode": is_fast_mode}, "previous_attempts": []}
        with open(history_file_path, 'w', encoding='utf-8') as f: json.dump(initial_history, f, indent=2, ensure_ascii=False)
        print(f"{Colors.CYAN}üíæ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {history_file_path}.{Colors.ENDC}")

    os.chdir(target_project_path)
    run_log_file_path = os.path.join(SLOTH_SCRIPT_DIR, RUN_LOG_FILE_NAME)
    try:
        with open(run_log_file_path, 'w', encoding='utf-8') as f: f.write(f"# SLOTH RUN LOG\n# –¶–µ–ª–µ–≤–æ–π –ø—Ä–æ–µ–∫—Ç: {target_project_path}\n# –†–µ–∂–∏–º: {'–ë—ã—Å—Ç—Ä—ã–π' if is_fast_mode else '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π'}\n")
    except Exception as e: print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å {run_log_file_path}: {e}{Colors.ENDC}")
    
    final_status = "–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
    try:
        final_status = main(is_fix_mode=args.fix, is_fast_mode=is_fast_mode, history_file_path=history_file_path, run_log_file_path=run_log_file_path)
    except KeyboardInterrupt: final_status = f"\n{Colors.OKBLUE}üîµ –ü—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.{Colors.ENDC}"
    except Exception as e:
        import traceback; traceback.print_exc()
        final_status = f"\n{Colors.FAIL}‚ùå –°–∫—Ä–∏–ø—Ç –∞–≤–∞—Ä–∏–π–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è: {e}{Colors.ENDC}"
    finally:
        print(f"\n{final_status}"); notify_user(final_status); print(f"\n{Colors.BOLD}üèÅ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.{Colors.ENDC}")
EOF
```
```summary
–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∫–æ–¥ –∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–∑-–∑–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `notify_user` –≤ `sloth_cli.py`. –í –∫–æ–Ω—Ü–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ —Å–Ω–∞—á–∞–ª–∞ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (`final_status`), –∞ –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `notify_user(final_status)`, –∫–æ—Ç–æ—Ä–∞—è –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –≤—ã–≤–æ–¥–∏—Ç –≤ –ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞—è –¥—É–±–ª–∏–∫–∞—Ç.

–Ø –∏—Å–ø—Ä–∞–≤–ª—é —ç—Ç–æ, –∏–∑–º–µ–Ω–∏–≤ –ª–æ–≥–∏—Ä—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ `notify_user`, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –ø–µ—á–∞—Ç–∞–ª–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –≤—ã–≤–æ–¥–∏–ª–∞ —Ç–æ–ª—å–∫–æ –æ–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏.
```

================================================================================
–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: EXECUTION, –ò—Ç–µ—Ä–∞—Ü–∏—è: 2)
--------------------------------------------------------------------------------

–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å shell-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ò–°–ü–û–õ–ù–ï–ù–ò–Ø:**

1.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ò–∑–º–µ–Ω–µ–Ω–∏–π:**
    *   **–¢–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ (`sed`):** –ò—Å–ø–æ–ª—å–∑—É–π `sed` **—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö** –∑–∞–º–µ–Ω.
    *   **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (`cat`):** –ò—Å–ø–æ–ª—å–∑—É–π `cat <<'EOF' > path/to/file.txt ... EOF` –¥–ª—è –ª—é–±—ã—Ö –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥.

2.  **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –§–∞–π–ª–æ–≤ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!):**
    *   **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cat` —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –ê–ö–ö–£–†–ê–¢–ï–ù. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π –≤ –±–ª–æ–∫ `EOF` **–ø–æ–ª–Ω–æ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    *   **–°—Ç—Ä–∞—Ç–µ–≥–∏—è "–û–¥–∏–Ω –∑–∞ —Ä–∞–∑":** –ï—Å–ª–∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω—è–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é**.

3.  **–§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞:**
    *   **–î–µ–π—Å—Ç–≤–∏—è:** –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥: ```bash ... ```.
        2.  –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ ‚Äî –±–ª–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ```summary ... ```.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞, –Ω–∞–ø–∏—à–∏ **—Ç–æ–ª—å–∫–æ** `–ì–û–¢–û–í–û`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ```done_summary ... ```. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `npm start`), –¥–æ–±–∞–≤—å –∏—Ö –≤ –±–ª–æ–∫ ```manual```.

**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `sed, rm, mv, touch, mkdir, npm, npx, yarn, pnpm, git, echo, ./, cat`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.




**–í–ê–ñ–ù–û:** –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–æ–¥ –Ω–∏–∂–µ ‚Äî —ç—Ç–æ **–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** –ø—Ä–æ–µ–∫—Ç–∞.

**–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø:**
1.  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â–∏–π** –∫–æ–¥, —É—á–∏—Ç—ã–≤–∞—è **–≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**.
2.  –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –Ω–∞–ø–∏—à–∏ `–ì–û–¢–û–í–û`.
3.  –ï—Å–ª–∏ —Ü–µ–ª—å –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
–°–µ–π—á–∞—Å —è –≤—ã–≥—Ä—É–∂—É –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞: —Å–Ω–∞—á–∞–ª–∞ –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –≤ —Å–∏–º–≤–æ–ª–∞—Ö, –∞ –ø–æ—Ç–æ–º –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

--- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ ---
lazy_develop/
‚îú‚îÄ‚îÄ colors.py (664 chars)
‚îú‚îÄ‚îÄ !!!context_collector.py (6540 chars)
‚îú‚îÄ‚îÄ sloth_cli.py (3128 chars)
‚îú‚îÄ‚îÄ !!!sloth_core.py (13197 chars)
‚îú‚îÄ‚îÄ sloth_plan.txt (1480 chars)
‚îî‚îÄ‚îÄ !!!sloth_runner.py (4141 chars)

--- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ ---

–§–∞–π–ª: colors.py
---------------
# File: colors.py
# Summary of declarations:

class Colors:
    ... # implementation

–§–∞–π–ª: context_collector.py
--------------------------
# File: context_collector.py
# Summary of declarations:

def _get_file_content(filepath)
    ... # implementation

def _summarize_content(content, filepath)
    ... # implementation

def _should_ignore(path, root_dir)
    ... # implementation

def gather_project_context(root_dir, mode='full', full_content_files=None, top_n_files=3)
    ... # implementation

–§–∞–π–ª: sloth_cli.py
------------------
# –§–∞–π–ª: sloth_cli.py
import os
import sys
import time
import re
import json
import platform
import subprocess
import argparse
from tkinter import Tk, filedialog

from colors import Colors
import sloth_core
import sloth_runner
import context_collector

# --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
MAX_ITERATIONS = 20
HISTORY_FILE_NAME = 'sloth_history.json'
RUN_LOG_FILE_NAME = 'sloth_run.log'

def calculate_cost(model_name, input_tokens, output_tokens):
    pricing_info = sloth_core.MODEL_PRICING.get(model_name)
    if not pricing_info: return 0.0
    total_cost = 0.0
    input_tiers = pricing_info.get("input", {}).get("tiers", [])
    for tier in input_tiers:
        if input_tokens <= tier["up_to"]:
            total_cost += (tier["price"] / 1_000_000) * input_tokens
            break
    output_tiers = pricing_info.get("output", {}).get("tiers", [])
    for tier in output_tiers:
        if input_tokens <= tier["up_to"]: 
            total_cost += (tier["price"] / 1_000_000) * output_tokens
            break
    return total_cost

def get_project_context(is_fast_mode, files_to_include_fully=None):
    print(f"{Colors.CYAN}üîÑ –õ–û–ì: –û–±–Ω–æ–≤–ª—è—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞...{Colors.ENDC}")
    try:
        if is_fast_mode:
            context_data = context_collector.gather_project_context(os.getcwd(), mode='full')
        else:
            mode = 'summarized'
            context_data = context_collector.gather_project_context(os.getcwd(), mode=mode, full_content_files=files_to_include_fully)
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω. –†–∞–∑–º–µ—Ä: {len(context_data)} —Å–∏–º–≤–æ–ª–æ–≤.{Colors.ENDC}")
        return context_data
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ get_project_context: {e}{Colors.ENDC}")
        return None

def _log_run(log_file_path, title, content):
    try:
        with open(log_file_path, 'a', encoding='utf-8') as f:
            f.write("\n" + "="*80 + "\n" + f"{title}\n" + "-"*80 + "\n")
            f.write(str(content if content is not None else "<empty>") + "\n")
    except Exception as e:
        print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ {log_file_path}: {e}{Colors.ENDC}")

def _read_multiline_input(prompt):
    print(prompt)
    lines = []
    empty_line_count = 0
    while empty_line_count < 3:
        try:
            line = input()
            if line: lines.append(line); empty_line_count = 0
            else: empty_line_count += 1
        except EOFError: break
    return '\n'.join(lines).strip()

def get_user_input():
    goal_prompt = (f"{Colors.HEADER}{Colors.BOLD}üëã –ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏ —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å.{Colors.ENDC}\n"
                   f"{Colors.CYAN}üí° (–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞, –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥){Colors.ENDC}")
    user_goal = _read_multiline_input(goal_prompt)
    if not user_goal: return None, None
    log_prompt = (f"\n{Colors.HEADER}{Colors.BOLD}üëç –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–≥ –æ—à–∏–±–∫–∏, –≤—Å—Ç–∞–≤—å –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞.{Colors.ENDC}")
    error_log = _read_multiline_input(log_prompt)
    return user_goal, error_log

def extract_block(tag, text):
    match = re.search(fr"


–§–∞–π–ª: sloth_core.py
-------------------
# –§–∞–π–ª: sloth_core.py
import vertexai
from vertexai.generative_models import GenerativeModel, HarmCategory, HarmBlockThreshold
import google.generativeai as genai
import os
from colors import Colors

# --- –ù–ê–°–¢–†–û–ô–ö–ò –Ø–î–†–ê ---
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY", "REDACTED_GOOGLE_API_KEY")
GOOGLE_CLOUD_PROJECT = "useful-gearbox-464618-v3"
GOOGLE_CLOUD_LOCATION = "us-central1"
MODEL_NAME = "gemini-2.5-pro"
API_TIMEOUT_SECONDS = 600
ALLOWED_COMMANDS = (
    "sed", "rm", "mv", "touch", "mkdir", "npm", "npx", "yarn", "pnpm", "git", "echo", "./", "cat"
)

MODEL_PRICING = {
    "gemini-2.5-pro": {
        "input": {
            "tiers": [
                {"up_to": 200000, "price": 1.25},
                {"up_to": float('inf'), "price": 2.50}
            ]
        },
        "output": {
            "tiers": [
                {"up_to": 200000, "price": 10.00},
                {"up_to": float('inf'), "price": 15.00}
            ]
        }
    },
    "gemini-1.5-pro-latest": {
        "input": { "tiers": [{"up_to": float('inf'), "price": 3.50}] },
        "output": { "tiers": [{"up_to": float('inf'), "price": 10.50}] }
    }
}

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è API, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —è–¥—Ä–æ–º ---
model = None
ACTIVE_API_SERVICE = "N/A"
GOOGLE_AI_HAS_FAILED_THIS_SESSION = False

def initialize_model():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥–µ–ª—å Gemini."""
    global model, ACTIVE_API_SERVICE, GOOGLE_AI_HAS_FAILED_THIS_SESSION

    print(f"{Colors.CYAN}‚öôÔ∏è  –õ–û–ì: –ù–∞—á–∏–Ω–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –ú–æ–¥–µ–ª—å: {MODEL_NAME}{Colors.ENDC}")
    generation_config = {"temperature": 1, "top_p": 1, "top_k": 1, "max_output_tokens": 32768}

    if not GOOGLE_AI_HAS_FAILED_THIS_SESSION and GOOGLE_API_KEY:
        print(f"{Colors.CYAN}üîë –õ–û–ì: –ü—Ä–æ–±—É—é –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å: Google AI (API Key)...{Colors.ENDC}")
        try:
            genai.configure(api_key=GOOGLE_API_KEY)
            model = genai.GenerativeModel(
                model_name=MODEL_NAME,
                generation_config=generation_config,
                safety_settings={'HARM_CATEGORY_HARASSMENT': 'block_medium_and_above', 'HARM_CATEGORY_HATE_SPEECH': 'block_medium_and_above', 'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'block_medium_and_above', 'HARM_CATEGORY_DANGEROUS_CONTENT': 'block_none'}
            )
            model.generate_content("test", request_options={"timeout": 60})
            ACTIVE_API_SERVICE = "Google AI (API Key)"
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –£—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ {ACTIVE_API_SERVICE}.{Colors.ENDC}")
            return
        except Exception as e:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Google AI API Key: {e}{Colors.ENDC}")
            print(f"{Colors.CYAN}üîÑ –õ–û–ì: –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (Vertex AI)...{Colors.ENDC}")
            GOOGLE_AI_HAS_FAILED_THIS_SESSION = True
            model = None

    if GOOGLE_AI_HAS_FAILED_THIS_SESSION:
         print(f"{Colors.CYAN}üî© –õ–û–ì: –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Vertex AI...{Colors.ENDC}")
    else:
         print(f"{Colors.CYAN}üîë –õ–û–ì: API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É—é Vertex AI.{Colors.ENDC}")

    try:
        vertexai.init(project=GOOGLE_CLOUD_PROJECT, location=GOOGLE_CLOUD_LOCATION)
        model = GenerativeModel(
             model_name=MODEL_NAME,
             generation_config=generation_config,
             safety_settings={HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE}
        )
        ACTIVE_API_SERVICE = "Vertex AI"
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: Vertex AI SDK —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.{Colors.ENDC}")
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å: {e}{Colors.ENDC}")
        model = None
        ACTIVE_API_SERVICE = "N/A"

def get_active_service_details():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –∏ —Å–µ—Ä–≤–∏—Å –¥–ª—è CLI."""
    return model, ACTIVE_API_SERVICE

def send_request_to_model(model_instance, active_service, prompt_text, iteration_count=0):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–∫–µ–Ω–∞—Ö."""
    global GOOGLE_AI_HAS_FAILED_THIS_SESSION
    try:
        log_header = f"[–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}]" if iteration_count > 0 else "[–≠—Ç–∞–ø –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è]"
        print(f"{Colors.CYAN}üß† –õ–û–ì: {log_header} –ì–æ—Ç–æ–≤–ª—é –∑–∞–ø—Ä–æ—Å –≤ –º–æ–¥–µ–ª—å ({active_service}).{Colors.ENDC}")
        print(f"{Colors.CYAN}‚è≥ –õ–û–ì: –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å... (—Ç–∞–π–º–∞—É—Ç: {API_TIMEOUT_SECONDS} —Å–µ–∫){Colors.ENDC}")
        
        response = None
        if active_service == "Google AI (API Key)":
            request_options = {"timeout": API_TIMEOUT_SECONDS}
            response = model_instance.generate_content(prompt_text, request_options=request_options)
        elif active_service == "Vertex AI":
            response = model_instance.generate_content(prompt_text)
        else:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å API: {active_service}")
        
        if not response: 
            raise ValueError("–û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø—É—Å—Ç–æ–π.")
            
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ.{Colors.ENDC}")
        
        return {
            "text": response.text,
            "input_tokens": response.usage_metadata.prompt_token_count,
            "output_tokens": response.usage_metadata.candidates_token_count
        }
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API ({active_service}): {e}{Colors.ENDC}")
        error_str = str(e).lower()
        if active_service == "Google AI (API Key)" and ("quota" in error_str or "rate limit" in error_str):
            print(f"{Colors.FAIL}üö® –õ–û–ì: –û–ë–ù–ê–†–£–ñ–ï–ù–ê –û–®–ò–ë–ö–ê –ö–í–û–¢–´!{Colors.ENDC}")
            print(f"{Colors.CYAN}   - –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ (–Ω–∞ —ç—Ç—É —Å–µ—Å—Å–∏—é) –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ Vertex AI...{Colors.ENDC}")
            GOOGLE_AI_HAS_FAILED_THIS_SESSION = True
            initialize_model()
        return None

def get_command_rules(stage='execution'):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞ (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ).
    """
    base_rules = f"""
**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `{', '.join(ALLOWED_COMMANDS)}`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.
"""

    if stage == 'execution':
        return f"""
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å shell-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ò–°–ü–û–õ–ù–ï–ù–ò–Ø:**

1.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ò–∑–º–µ–Ω–µ–Ω–∏–π:**
    *   **–¢–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ (`sed`):** –ò—Å–ø–æ–ª—å–∑—É–π `sed` **—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö** –∑–∞–º–µ–Ω.
    *   **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (`cat`):** –ò—Å–ø–æ–ª—å–∑—É–π `cat <<'EOF' > path/to/file.txt ... EOF` –¥–ª—è –ª—é–±—ã—Ö –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥.

2.  **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –§–∞–π–ª–æ–≤ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!):**
    *   **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cat` —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –ê–ö–ö–£–†–ê–¢–ï–ù. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π –≤ –±–ª–æ–∫ `EOF` **–ø–æ–ª–Ω–æ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    *   **–°—Ç—Ä–∞—Ç–µ–≥–∏—è "–û–¥–∏–Ω –∑–∞ —Ä–∞–∑":** –ï—Å–ª–∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω—è–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é**.

3.  **–§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞:**
    *   **–î–µ–π—Å—Ç–≤–∏—è:** –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥: ```bash ... ```.
        2.  –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ ‚Äî –±–ª–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ```summary ... ```.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞, –Ω–∞–ø–∏—à–∏ **—Ç–æ–ª—å–∫–æ** `–ì–û–¢–û–í–û`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ```done_summary ... ```. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `npm start`), –¥–æ–±–∞–≤—å –∏—Ö –≤ –±–ª–æ–∫ ```manual```.
{base_rules}
"""

    if stage == 'planning':
        return f"""
–¢—ã ‚Äî AI-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. –¢–≤–æ—è –ø–µ—Ä–≤–∞—è –∏ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è—Ç–µ–Ω.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–Ø:**

1.  **–ê–Ω–∞–ª–∏–∑ –ó–∞–¥–∞—á–∏:** –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π **—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π** –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã).
2.  **–î–≤–∞ –ü—É—Ç–∏ –†–∞–∑–≤–∏—Ç–∏—è:**
    *   **–ü—É—Ç—å –ê: –ó–∞–¥–∞—á–∞ –ù–ï–ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ—á–µ—Ç–∫–æ, –Ω–µ–ø–æ–ª–Ω–æ –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–ª—å–∑—è –Ω–∞–π—Ç–∏ –≤ –∫–æ–¥–µ ‚Äî **–∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ** –±–ª–æ–∫ ```clarification ... ``` —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–ª–∞–Ω –∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π —Ñ–∞–π–ª—ã.
    *   **–ü—É—Ç—å –ë: –ó–∞–¥–∞—á–∞ –ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ —Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. –¢–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  **–ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π:** ```plan ... ```. –û–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–º.
        2.  **–°–ø–∏—Å–æ–∫ –§–∞–π–ª–æ–≤:** ```files ... ```. –ü–µ—Ä–µ—á–∏—Å–ª–∏ **–≤—Å–µ** —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ, –ø–æ —Ç–≤–æ–µ–º—É –º–Ω–µ–Ω–∏—é, –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞. –£–∫–∞–∑—ã–≤–∞–π –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ. –ù–µ —ç–∫–æ–Ω–æ–º—å! –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –∫–∞—á–µ—Å—Ç–≤–æ - –∑–∞–ø—Ä–æ—Å–∏ –≤—Å–µ —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–ª–∏ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è!!! –≠—Ç–æ –≤–∞–∂–Ω–æ - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ö–ê–ß–ï–°–¢–í–û!
3.  **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ **–ó–ê–ü–†–ï–©–ï–ù–û** –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ```bash``` –∏–ª–∏ ```summary```. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ª–∏–±–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ª–∏–±–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∞–π–ª—ã.
{base_rules}
"""

def get_clarification_and_planning_prompt(context, task):
    """
    –ù–û–í–´–ô –ü–†–û–ú–ü–¢: –î–ª—è —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –≤ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.
    """
    rules = get_command_rules(stage='planning')
    return f"""{rules}

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–°–û–ö–†–ê–©–ï–ù–ù–´–ô) ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

--- –ó–ê–î–ê–ß–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
{task}
--- –ö–û–ù–ï–¶ –ó–ê–î–ê–ß–ò ---

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –°–ª–µ–¥—É–π –ø—Ä–∞–≤–∏–ª–∞–º —ç—Ç–∞–ø–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ª–∏–±–æ –∑–∞–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è (`clarification`), –ª–∏–±–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω (`plan`) –∏ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (`files`).
"""

def get_initial_prompt(context, task, fix_history=None):
    """
    –≠—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞ **—ç—Ç–∞–ø–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è**.
    """
    history_prompt_section = ""
    if fix_history:
        history_prompt_section = f"""
--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ï–ì–û –†–ï–®–ï–ù–ò–Ø, –ö–û–¢–û–†–û–ï –û–ö–ê–ó–ê–õ–û–°–¨ –ù–ï–í–ï–†–ù–´–ú ---
{fix_history}
--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–≤–æ—é –ø—Ä–æ—à–ª—É—é –æ—à–∏–±–∫—É –∏ –Ω–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ.
"""
    return f"{get_command_rules(stage='execution')}\n{history_prompt_section}\n--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–ü–û–õ–ù–´–ô –ò–õ–ò –ß–ê–°–¢–ò–ß–ù–´–ô) ---\n{context}\n--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---\n–ó–∞–¥–∞—á–∞: {task}\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –æ—Ç–≤–µ—Ç, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è."

def get_review_prompt(context, goal, iteration_count, attempt_history):
    iteration_info = ""
    if iteration_count >= 4:
        iteration_info = f"\n**–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}):** –¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ.\n"
    history_info = ""
    if attempt_history:
        history_info = (
            "--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---\n" +
            "\n---\n".join(attempt_history) +
            "\n--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---\n"
        )
    return f"""{get_command_rules(stage='execution')}
{iteration_info}
{history_info}
**–í–ê–ñ–ù–û:** –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–æ–¥ –Ω–∏–∂–µ ‚Äî —ç—Ç–æ **–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** –ø—Ä–æ–µ–∫—Ç–∞.

**–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø:**
1.  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â–∏–π** –∫–æ–¥, —É—á–∏—Ç—ã–≤–∞—è **–≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**.
2.  –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –Ω–∞–ø–∏—à–∏ `–ì–û–¢–û–í–û`.
3.  –ï—Å–ª–∏ —Ü–µ–ª—å –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

–ù–∞–ø–æ–º–∏–Ω–∞—é –ò–°–•–û–î–ù–£–Æ –¶–ï–õ–¨: {goal}
"""

def get_error_fixing_prompt(failed_command, error_message, goal, context, iteration_count, attempt_history):
    iteration_info = ""
    if iteration_count >= 4:
        iteration_info = f"\n**–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}):** –¢—ã —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤, –∏ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ.\n"
    history_info = ""
    if attempt_history:
        history_info = (
            "--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---\n" +
            "\n---\n".join(attempt_history) +
            "\n--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---\n"
        )
    return f"""{get_command_rules(stage='execution')}
{iteration_info}
{history_info}
**–í–ê–ñ–ù–û:** –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞. –ù–µ –ø–∏—à–∏ '–ì–û–¢–û–í–û'.

--- –î–ê–ù–ù–´–ï –û –¢–ï–ö–£–©–ï–ô –û–®–ò–ë–ö–ï ---
–ö–û–ú–ê–ù–î–ê: {failed_command}
–°–û–û–ë–©–ï–ù–ò–ï (stderr): {error_message}
--- –ö–û–ù–ï–¶ –î–ê–ù–ù–´–• –û–ë –û–®–ò–ë–ö–ï ---

–ò—Å—Ö–æ–¥–Ω–∞—è –¶–ï–õ–¨ –±—ã–ª–∞: {goal}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â—É—é –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏** –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å **–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥** –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢, –ì–î–ï –ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---
"""

–§–∞–π–ª: sloth_plan.txt
--------------------
1.  **–ê–Ω–∞–ª–∏–∑ `sloth_cli.py`**: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `main`. –ú–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–π—Ç–∏, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –Ø –±—É–¥—É –∏—Å–∫–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Ç–≤–µ—Ç –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–æ–∫ `manual`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø") –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å. –ï—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –∞ –∑–∞—Ç–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –±–ª–æ–∫ `manual` –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –¢–∞–∫–∂–µ —è –ø—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `notify_user`.
2.  **–ê–Ω–∞–ª–∏–∑ `sloth_core.py`**: –ò–∑—É—á—É —Ñ—É–Ω–∫—Ü–∏—é `send_request_to_model`, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ `sloth_cli.py`. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ, —Ö–æ—Ç—è —ç—Ç–æ –∏ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ.
3.  **–ê–Ω–∞–ª–∏–∑ `sloth_runner.py`**: –ü—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `execute_commands`. –•–æ—Ç—è –æ–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `bash`-–∫–æ–º–∞–Ω–¥, –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Ç–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ `manual`.
4.  **–í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –°–æ–ø–æ—Å—Ç–∞–≤–∏–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ñ–∞–π–ª–æ–≤, —è –æ—Ç—Å–ª–µ–∂—É –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ –∏ –Ω–∞–π–¥—É –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã `print` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞ –≤—ã–≤–æ–¥ –±–ª–æ–∫–∞ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø".
5.  **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ –≤ `sloth_cli.py`.
6.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ç—á–∞**: –Ø —Å–æ–∑–¥–∞–º `bash`-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `sed`.

–§–∞–π–ª: sloth_runner.py
---------------------
# –§–∞–π–ª: sloth_runner.py
import subprocess
import platform
import re
import hashlib
import os
from colors import Colors

def get_file_hash(filepath):
    """–í—ã—á–∏—Å–ª—è–µ—Ç SHA256 —Ö—ç—à —Ñ–∞–π–ª–∞."""
    if not os.path.exists(filepath) or os.path.isdir(filepath): return None
    h = hashlib.sha256()
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(8192)
            if not chunk: break
            h.update(chunk)
    return h.hexdigest()

def execute_commands(commands_str):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–ª–æ–∫ shell-–∫–æ–º–∞–Ω–¥.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂: (success, failed_command, error_message)
    """
    print(f"{Colors.OKBLUE}  [–î–µ—Ç–∞–ª–∏] –ó–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞ –∫–æ–º–∞–Ω–¥...{Colors.ENDC}")

    # –ò–ó–ú–ï–ù–ï–ù–û: –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–∏—Å–∫–∞ –ø—É—Ç–µ–π, –≤–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    filepaths = re.findall(r'[\'"]?([a-zA-Z0-9_\-\.\/]+)[\'"]?', commands_str)
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
    hashes_before = {fp: get_file_hash(fp) for fp in filepaths if os.path.isfile(fp)}
    dirs_before = {fp for fp in filepaths if os.path.isdir(fp)}
    files_before = {fp for fp in filepaths if os.path.exists(fp)} # –í—Å–µ –ø—É—Ç–∏, –≤–∫–ª—é—á–∞—è –ø–∞–ø–∫–∏
    
    try:
        is_macos = platform.system() == "Darwin"
        # –î–ª—è macOS –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ .bak –¥–ª—è sed -i, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ –≤ Linux
        commands_str_adapted = re.sub(r"sed -i ", "sed -i '.bak' ", commands_str) if is_macos else commands_str
        full_command = f"set -e\n{commands_str_adapted}"

        print(f"{Colors.WARNING}‚ö°Ô∏è –õ–û–ì: –í—ã–ø–æ–ª–Ω—è—é –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ (bash, set -e)...{Colors.ENDC}")
        result = subprocess.run(['bash', '-c', full_command], capture_output=True, text=True, encoding='utf-8')

        if result.returncode != 0:
            error_msg = f"–ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞ ({result.returncode}).\n–û—à–∏–±–∫–∞ (STDERR): {result.stderr.strip()}"
            print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–ª–æ–∫–∞ –∫–æ–º–∞–Ω–¥.\n{error_msg}{Colors.ENDC}")
            return False, commands_str, result.stderr.strip() or "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å –±–µ–∑ –≤—ã–≤–æ–¥–∞ –≤ stderr."

        if result.stderr:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (STDERR –æ—Ç —É—Å–ø–µ—à–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã):\n{result.stderr.strip()}{Colors.ENDC}")

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã .bak, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ sed –Ω–∞ macOS
        if is_macos:
            subprocess.run("find . -name '*.bak' -delete", shell=True, check=True, capture_output=True)

        # --- –ù–û–í–ê–Ø, –ë–û–õ–ï–ï –ù–ê–î–ï–ñ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        hashes_after = {fp: get_file_hash(fp) for fp in hashes_before.keys()}
        files_after = {fp for fp in filepaths if os.path.exists(fp)}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ö—ç—à —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
        modified_files = any(hashes_before.get(fp) != hashes_after.get(fp) for fp in hashes_before)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–∞–ø–∫–∏
        created_paths = files_after - files_before
        
        if not modified_files and not created_paths:
            # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ –Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å - —ç—Ç–æ –æ—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏
            error_msg = ("–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞ –∏ –Ω–µ —Å–æ–∑–¥–∞–ª–∞ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏. "
                         "–í–µ—Ä–æ—è—Ç–Ω–æ, —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ sed) –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–µ–≤–µ—Ä–µ–Ω.")
            final_error_message = result.stderr.strip() if result.stderr else error_msg
            print(f"{Colors.FAIL}‚ùå –õ–û–ì: –û–®–ò–ë–ö–ê –õ–û–ì–ò–ö–ò: {error_msg}{Colors.ENDC}")
            if result.stderr:
                print(f"–ü—Ä–∏—á–∏–Ω–∞ –∏–∑ STDERR: {final_error_message}")
            return False, commands_str, final_error_message

        # –ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è, –≤—Å–µ —Ö–æ—Ä–æ—à–æ
        if modified_files:
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –§–∞–π–ª—ã –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã.{Colors.ENDC}")
        if created_paths:
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ –ø—É—Ç–∏: {', '.join(created_paths)}{Colors.ENDC}")
            
        return True, None, None

    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –û–®–ò–ë–ö–ê –≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ: {e}{Colors.ENDC}")
        return False, commands_str, str(e)
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

–ù–∞–ø–æ–º–∏–Ω–∞—é –ò–°–•–û–î–ù–£–Æ –¶–ï–õ–¨: "‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø: –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –∑–∞—á–µ–º-—Ç–æ 
–º–æ–∂–µ–º –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏ –∏–∑–º–µ–Ω–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –ª–∏—à—å –µ–¥–∏–Ω–æ–∂–¥—ã –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ - —è –Ω–µ —Ö–æ—á—É —É—Ç–æ—á–Ω—è—Ç—å –ª–∏—à–Ω–µ–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–±–æ–ª—å—à–µ —Ñ–∞–π–ª–æ–≤ –∏ —Ä–∞–∑–±–µ—Ä–∏—Å—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ—á–µ–º—É —Ç–∞–∫ - —ç—Ç–æ –∫–æ–≥–¥–∞ –º—ã –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–æ–π –±–ª–æ–∫ –∏ –≤–æ—Ç –æ–Ω –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è


================================================================================
–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: EXECUTION, –ò—Ç–µ—Ä–∞—Ü–∏—è: 2)
--------------------------------------------------------------------------------
–ü–æ—Å–∫–æ–ª—å–∫—É —Ñ–∞–π–ª `sloth_cli.py` –±—ã–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω (—Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞) –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ñ—É–Ω–∫—Ü–∏—è `main`), —è –ø–æ–ª–Ω–æ—Å—Ç—å—é –µ–≥–æ –ø–µ—Ä–µ–ø–∏—à—É.

–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è `sloth_cli.py` –±—É–¥–µ—Ç –≤–∫–ª—é—á–∞—Ç—å:
1.  **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é** —Ñ—É–Ω–∫—Ü–∏—é `extract_block` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏.
2.  **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏** –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `calculate_cost`, –≥–¥–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö.
3.  **–†–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ `main`**, –∫–æ—Ç–æ—Ä–∞—è —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º —Ü–∏–∫–ª–æ–º —Ä–∞–±–æ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏, –æ–±—â–µ–Ω–∏–µ —Å –º–æ–¥–µ–ª—å—é, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞.
4.  **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞:** –õ–æ–≥–∏–∫–∞ –≤ `main` —Ç–µ–ø–µ—Ä—å —Å–Ω–∞—á–∞–ª–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏ (`summary`, `bash`, `manual` –∏ –¥—Ä.) –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏, –∞ –∑–∞—Ç–µ–º –≤—ã–≤–æ–¥–∏—Ç –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –æ—Ç–¥–µ–ª—å–Ω–æ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±–ª–æ–∫ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø" (–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π) –±—É–¥–µ—Ç –Ω–∞–ø–µ—á–∞—Ç–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.

```bash
cat <<'EOF' > sloth_cli.py
# –§–∞–π–ª: sloth_cli.py
import os
import sys
import time
import re
import json
import platform
import subprocess
import argparse
from tkinter import Tk, filedialog

from colors import Colors
import sloth_core
import sloth_runner
import context_collector

# --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
MAX_ITERATIONS = 20
HISTORY_FILE_NAME = 'sloth_history.json'
RUN_LOG_FILE_NAME = 'sloth_run.log'

def calculate_cost(model_name, input_tokens, output_tokens):
    pricing_info = sloth_core.MODEL_PRICING.get(model_name)
    if not pricing_info: return 0.0
    total_cost = 0.0
    input_tiers = pricing_info.get("input", {}).get("tiers", [])
    for tier in input_tiers:
        if input_tokens <= tier["up_to"]:
            total_cost += (tier["price"] / 1_000_000) * input_tokens
            break
    output_tiers = pricing_info.get("output", {}).get("tiers", [])
    for tier in output_tiers:
        if output_tokens <= tier["up_to"]: 
            total_cost += (tier["price"] / 1_000_000) * output_tokens
            break
    return total_cost

def get_project_context(is_fast_mode, files_to_include_fully=None):
    print(f"{Colors.CYAN}üîÑ –õ–û–ì: –û–±–Ω–æ–≤–ª—è—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞...{Colors.ENDC}")
    try:
        if is_fast_mode:
            context_data = context_collector.gather_project_context(os.getcwd(), mode='full')
        else:
            mode = 'summarized'
            context_data = context_collector.gather_project_context(os.getcwd(), mode=mode, full_content_files=files_to_include_fully)
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω. –†–∞–∑–º–µ—Ä: {len(context_data)} —Å–∏–º–≤–æ–ª–æ–≤.{Colors.ENDC}")
        return context_data
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ get_project_context: {e}{Colors.ENDC}")
        return None

def _log_run(log_file_path, title, content):
    try:
        with open(log_file_path, 'a', encoding='utf-8') as f:
            f.write("\n" + "="*80 + "\n" + f"{title}\n" + "-"*80 + "\n")
            f.write(str(content if content is not None else "<empty>") + "\n")
    except Exception as e:
        print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ {log_file_path}: {e}{Colors.ENDC}")

def _read_multiline_input(prompt):
    print(prompt)
    lines = []
    empty_line_count = 0
    while empty_line_count < 3:
        try:
            line = input()
            if line: lines.append(line); empty_line_count = 0
            else: empty_line_count += 1
        except EOFError: break
    return '\n'.join(lines).strip()

def get_user_input():
    goal_prompt = (f"{Colors.HEADER}{Colors.BOLD}üëã –ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏ —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å.{Colors.ENDC}\n"
                   f"{Colors.CYAN}üí° (–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞, –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥){Colors.ENDC}")
    user_goal = _read_multiline_input(goal_prompt)
    if not user_goal: return None, None
    log_prompt = (f"\n{Colors.HEADER}{Colors.BOLD}üëç –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–≥ –æ—à–∏–±–∫–∏, –≤—Å—Ç–∞–≤—å –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞.{Colors.ENDC}")
    error_log = _read_multiline_input(log_prompt)
    return user_goal, error_log

def extract_block(tag, text):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä ```tag...```"""
    pattern = fr"```{tag}\n(.*?)\n```"
    match = re.search(pattern, text, re.DOTALL)
    if match:
        return match.group(1).strip()
    return None

def main():
    parser = argparse.ArgumentParser(description="Sloth: AI-powered coding assistant.")
    parser.add_argument("task", nargs='?', default=None, help="The development task to perform.")
    parser.add_argument("--fast-mode", action="store_true", help="Disables context summarization.")
    args = parser.parse_args()

    user_goal, error_log = (args.task, None) if args.task else get_user_input()
    if not user_goal:
        print(f"{Colors.WARNING}–¶–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞. –í—ã—Ö–æ–¥.{Colors.ENDC}")
        return

    task_full = f"–ó–ê–î–ê–ß–ê: {user_goal}"
    if error_log:
        task_full += f"\n\n–õ–û–ì –û–®–ò–ë–ö–ò:\n{error_log}"

    sloth_core.initialize_model()
    model, active_service = sloth_core.get_active_service_details()

    if not model:
        print(f"{Colors.FAIL}–ú–æ–¥–µ–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. –í—ã—Ö–æ–¥.{Colors.ENDC}")
        return
    
    current_context = get_project_context(args.fast_mode)
    prompt = sloth_core.get_initial_prompt(current_context, task_full)
    attempt_history = []
    
    total_cost = 0.0
    for i in range(MAX_ITERATIONS):
        iteration_count = i + 1
        print(f"\n{Colors.HEADER}--- –ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}/{MAX_ITERATIONS} ---{Colors.ENDC}")

        response_data = sloth_core.send_request_to_model(model, active_service, prompt, iteration_count)

        if not response_data:
            print(f"{Colors.FAIL}–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –ü—Ä–µ—Ä—ã–≤–∞—é...{Colors.ENDC}")
            break

        model_response_text = response_data['text']
        _log_run(RUN_LOG_FILE_NAME, f"–ò–¢–ï–†–ê–¶–ò–Ø {iteration_count}", model_response_text)
        
        cost = calculate_cost(sloth_core.MODEL_NAME, response_data['input_tokens'], response_data['output_tokens'])
        total_cost += cost
        print(f"{Colors.YELLOW}üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞: ${cost:.6f} | –í—Å–µ–≥–æ: ${total_cost:.6f}{Colors.ENDC}")
        
        attempt_history.append(model_response_text)
        
        summary = extract_block("summary", model_response_text)
        bash_commands = extract_block("bash", model_response_text)
        manual_actions = extract_block("manual", model_response_text)
        done_summary = extract_block("done_summary", model_response_text)

        if summary:
            print(f"{Colors.OKBLUE}üìù –ü–æ—è—Å–Ω–µ–Ω–∏–µ –æ—Ç –ò–ò:{Colors.ENDC}\n{summary}")

        if model_response_text.strip().startswith("–ì–û–¢–û–í–û"):
            print(f"\n{Colors.OKGREEN}{Colors.BOLD}‚úÖ –ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê!{Colors.ENDC}")
            if done_summary:
                print(f"{Colors.CYAN}üèÅ –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ–∑—é–º–µ:{Colors.ENDC}\n{done_summary}")
            if manual_actions:
                print(f"\n{Colors.HEADER}‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:{Colors.ENDC}\n{manual_actions}")
            break
        
        if bash_commands:
            success, failed_cmd, error_msg = sloth_runner.execute_commands(bash_commands)
            if success:
                current_context = get_project_context(args.fast_mode)
                prompt = sloth_core.get_review_prompt(current_context, user_goal, iteration_count, attempt_history)
            else:
                current_context = get_project_context(args.fast_mode)
                prompt = sloth_core.get_error_fixing_prompt(failed_cmd, error_msg, user_goal, current_context, iteration_count, attempt_history)
        elif manual_actions:
            print(f"\n{Colors.HEADER}{Colors.BOLD}‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:{Colors.ENDC}\n{manual_actions}")
            print(f"{Colors.WARNING}–ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–±—É—é—Ç—Å—è —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.{Colors.ENDC}")
            break
        else:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ú–æ–¥–µ–ª—å –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∞ –Ω–∏ –∫–æ–º–∞–Ω–¥, –Ω–∏ —Ä—É—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π. –ó–∞–≤–µ—Ä—à–∞—é —Å–µ—Å—Å–∏—é.{Colors.ENDC}")
            print(f"{Colors.BOLD}ü§ñ –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ò–ò:{Colors.ENDC}\n{model_response_text}")
            break

    else:
        print(f"{Colors.FAIL}–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π ({MAX_ITERATIONS}). –ó–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É.{Colors.ENDC}")
    
    print(f"\n{Colors.BOLD}{Colors.OKGREEN}–†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${total_cost:.6f}{Colors.ENDC}")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n\n{Colors.WARNING}üö´ –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –í—ã—Ö–æ–¥.{Colors.ENDC}")
        sys.exit(0)
EOF
```
```summary
–Ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–ª —Ñ–∞–π–ª `sloth_cli.py`, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±—ã–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω. –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É –≤ —Ä–∞—Å—á–µ—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏, –≥–ª–∞–≤–Ω–æ–µ, —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –±–ª–æ–∫–∞ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø", –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—è –∏ –≤—ã–≤–æ–¥—è –∫–∞–∂–¥—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ.
```

================================================================================
–ó–ê–ü–†–û–° (–°–æ—Å—Ç–æ—è–Ω–∏–µ: EXECUTION, –ò—Ç–µ—Ä–∞—Ü–∏—è: 3)
--------------------------------------------------------------------------------

–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å shell-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ò–°–ü–û–õ–ù–ï–ù–ò–Ø:**

1.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ò–∑–º–µ–Ω–µ–Ω–∏–π:**
    *   **–¢–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ (`sed`):** –ò—Å–ø–æ–ª—å–∑—É–π `sed` **—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö** –∑–∞–º–µ–Ω.
    *   **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (`cat`):** –ò—Å–ø–æ–ª—å–∑—É–π `cat <<'EOF' > path/to/file.txt ... EOF` –¥–ª—è –ª—é–±—ã—Ö –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥.

2.  **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –§–∞–π–ª–æ–≤ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!):**
    *   **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cat` —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –ê–ö–ö–£–†–ê–¢–ï–ù. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π –≤ –±–ª–æ–∫ `EOF` **–ø–æ–ª–Ω–æ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    *   **–°—Ç—Ä–∞—Ç–µ–≥–∏—è "–û–¥–∏–Ω –∑–∞ —Ä–∞–∑":** –ï—Å–ª–∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω—è–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é**.

3.  **–§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞:**
    *   **–î–µ–π—Å—Ç–≤–∏—è:** –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥: ```bash ... ```.
        2.  –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ ‚Äî –±–ª–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ```summary ... ```.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞, –Ω–∞–ø–∏—à–∏ **—Ç–æ–ª—å–∫–æ** `–ì–û–¢–û–í–û`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ```done_summary ... ```. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `npm start`), –¥–æ–±–∞–≤—å –∏—Ö –≤ –±–ª–æ–∫ ```manual```.

**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `sed, rm, mv, touch, mkdir, npm, npx, yarn, pnpm, git, echo, ./, cat`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.



--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---
**–ò—Ç–µ—Ä–∞—Ü–∏—è 1:**
**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∫–æ–¥ –∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª, —á—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–∑-–∑–∞ —Ñ—É–Ω–∫—Ü–∏–∏ `notify_user` –≤ `sloth_cli.py`. –í –∫–æ–Ω—Ü–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ —Å–Ω–∞—á–∞–ª–∞ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (`final_status`), –∞ –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `notify_user(final_status)`, –∫–æ—Ç–æ—Ä–∞—è –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å –≤—ã–≤–æ–¥–∏—Ç –≤ –ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞—è –¥—É–±–ª–∏–∫–∞—Ç.

–Ø –∏—Å–ø—Ä–∞–≤–ª—é —ç—Ç–æ, –∏–∑–º–µ–Ω–∏–≤ –ª–æ–≥–∏—Ä—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ `notify_user`, —á—Ç–æ–±—ã –æ–Ω–∞ –Ω–µ –ø–µ—á–∞—Ç–∞–ª–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∞ –≤—ã–≤–æ–¥–∏–ª–∞ —Ç–æ–ª—å–∫–æ –æ–±—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏.
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£–°–ü–ï–•
--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---

**–í–ê–ñ–ù–û:** –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–æ–¥ –Ω–∏–∂–µ ‚Äî —ç—Ç–æ **–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** –ø—Ä–æ–µ–∫—Ç–∞.

**–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø:**
1.  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â–∏–π** –∫–æ–¥, —É—á–∏—Ç—ã–≤–∞—è **–≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**.
2.  –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –Ω–∞–ø–∏—à–∏ `–ì–û–¢–û–í–û`.
3.  –ï—Å–ª–∏ —Ü–µ–ª—å –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
–°–µ–π—á–∞—Å —è –≤—ã–≥—Ä—É–∂—É –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞: —Å–Ω–∞—á–∞–ª–∞ –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –≤ —Å–∏–º–≤–æ–ª–∞—Ö, –∞ –ø–æ—Ç–æ–º –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

--- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ ---
lazy_develop/
‚îú‚îÄ‚îÄ colors.py (664 chars)
‚îú‚îÄ‚îÄ !!!context_collector.py (6540 chars)
‚îú‚îÄ‚îÄ sloth_cli.py (3157 chars)
‚îú‚îÄ‚îÄ !!!sloth_core.py (13197 chars)
‚îú‚îÄ‚îÄ sloth_plan.txt (1480 chars)
‚îî‚îÄ‚îÄ !!!sloth_runner.py (4141 chars)

--- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ ---

–§–∞–π–ª: colors.py
---------------
# File: colors.py
# Summary of declarations:

class Colors:
    ... # implementation

–§–∞–π–ª: context_collector.py
--------------------------
# File: context_collector.py
# Summary of declarations:

def _get_file_content(filepath)
    ... # implementation

def _summarize_content(content, filepath)
    ... # implementation

def _should_ignore(path, root_dir)
    ... # implementation

def gather_project_context(root_dir, mode='full', full_content_files=None, top_n_files=3)
    ... # implementation

–§–∞–π–ª: sloth_cli.py
------------------
# –§–∞–π–ª: sloth_cli.py
import os
import sys
import time
import re
import json
import platform
import subprocess
import argparse
from tkinter import Tk, filedialog

from colors import Colors
import sloth_core
import sloth_runner
import context_collector

# --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
MAX_ITERATIONS = 20
HISTORY_FILE_NAME = 'sloth_history.json'
RUN_LOG_FILE_NAME = 'sloth_run.log'

def calculate_cost(model_name, input_tokens, output_tokens):
    pricing_info = sloth_core.MODEL_PRICING.get(model_name)
    if not pricing_info: return 0.0
    total_cost = 0.0
    input_tiers = pricing_info.get("input", {}).get("tiers", [])
    for tier in input_tiers:
        if input_tokens <= tier["up_to"]:
            total_cost += (tier["price"] / 1_000_000) * input_tokens
            break
    output_tiers = pricing_info.get("output", {}).get("tiers", [])
    for tier in output_tiers:
        if output_tokens <= tier["up_to"]: 
            total_cost += (tier["price"] / 1_000_000) * output_tokens
            break
    return total_cost

def get_project_context(is_fast_mode, files_to_include_fully=None):
    print(f"{Colors.CYAN}üîÑ –õ–û–ì: –û–±–Ω–æ–≤–ª—è—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞...{Colors.ENDC}")
    try:
        if is_fast_mode:
            context_data = context_collector.gather_project_context(os.getcwd(), mode='full')
        else:
            mode = 'summarized'
            context_data = context_collector.gather_project_context(os.getcwd(), mode=mode, full_content_files=files_to_include_fully)
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω. –†–∞–∑–º–µ—Ä: {len(context_data)} —Å–∏–º–≤–æ–ª–æ–≤.{Colors.ENDC}")
        return context_data
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ get_project_context: {e}{Colors.ENDC}")
        return None

def _log_run(log_file_path, title, content):
    try:
        with open(log_file_path, 'a', encoding='utf-8') as f:
            f.write("\n" + "="*80 + "\n" + f"{title}\n" + "-"*80 + "\n")
            f.write(str(content if content is not None else "<empty>") + "\n")
    except Exception as e:
        print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ {log_file_path}: {e}{Colors.ENDC}")

def _read_multiline_input(prompt):
    print(prompt)
    lines = []
    empty_line_count = 0
    while empty_line_count < 3:
        try:
            line = input()
            if line: lines.append(line); empty_line_count = 0
            else: empty_line_count += 1
        except EOFError: break
    return '\n'.join(lines).strip()

def get_user_input():
    goal_prompt = (f"{Colors.HEADER}{Colors.BOLD}üëã –ü—Ä–∏–≤–µ—Ç! –û–ø–∏—à–∏ —Å–≤–æ—é –æ—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å.{Colors.ENDC}\n"
                   f"{Colors.CYAN}üí° (–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞, –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞ –ø–æ–¥—Ä—è–¥){Colors.ENDC}")
    user_goal = _read_multiline_input(goal_prompt)
    if not user_goal: return None, None
    log_prompt = (f"\n{Colors.HEADER}{Colors.BOLD}üëç –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –µ—Å—Ç—å –ª–æ–≥ –æ—à–∏–±–∫–∏, –≤—Å—Ç–∞–≤—å –µ–≥–æ. –ï—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ Enter 3 —Ä–∞–∑–∞.{Colors.ENDC}")
    error_log = _read_multiline_input(log_prompt)
    return user_goal, error_log

def extract_block(tag, text):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä


–§–∞–π–ª: sloth_core.py
-------------------
# –§–∞–π–ª: sloth_core.py
import vertexai
from vertexai.generative_models import GenerativeModel, HarmCategory, HarmBlockThreshold
import google.generativeai as genai
import os
from colors import Colors

# --- –ù–ê–°–¢–†–û–ô–ö–ò –Ø–î–†–ê ---
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY", "REDACTED_GOOGLE_API_KEY")
GOOGLE_CLOUD_PROJECT = "useful-gearbox-464618-v3"
GOOGLE_CLOUD_LOCATION = "us-central1"
MODEL_NAME = "gemini-2.5-pro"
API_TIMEOUT_SECONDS = 600
ALLOWED_COMMANDS = (
    "sed", "rm", "mv", "touch", "mkdir", "npm", "npx", "yarn", "pnpm", "git", "echo", "./", "cat"
)

MODEL_PRICING = {
    "gemini-2.5-pro": {
        "input": {
            "tiers": [
                {"up_to": 200000, "price": 1.25},
                {"up_to": float('inf'), "price": 2.50}
            ]
        },
        "output": {
            "tiers": [
                {"up_to": 200000, "price": 10.00},
                {"up_to": float('inf'), "price": 15.00}
            ]
        }
    },
    "gemini-1.5-pro-latest": {
        "input": { "tiers": [{"up_to": float('inf'), "price": 3.50}] },
        "output": { "tiers": [{"up_to": float('inf'), "price": 10.50}] }
    }
}

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è API, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —è–¥—Ä–æ–º ---
model = None
ACTIVE_API_SERVICE = "N/A"
GOOGLE_AI_HAS_FAILED_THIS_SESSION = False

def initialize_model():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥–µ–ª—å Gemini."""
    global model, ACTIVE_API_SERVICE, GOOGLE_AI_HAS_FAILED_THIS_SESSION

    print(f"{Colors.CYAN}‚öôÔ∏è  –õ–û–ì: –ù–∞—á–∏–Ω–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é. –ú–æ–¥–µ–ª—å: {MODEL_NAME}{Colors.ENDC}")
    generation_config = {"temperature": 1, "top_p": 1, "top_k": 1, "max_output_tokens": 32768}

    if not GOOGLE_AI_HAS_FAILED_THIS_SESSION and GOOGLE_API_KEY:
        print(f"{Colors.CYAN}üîë –õ–û–ì: –ü—Ä–æ–±—É—é –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å: Google AI (API Key)...{Colors.ENDC}")
        try:
            genai.configure(api_key=GOOGLE_API_KEY)
            model = genai.GenerativeModel(
                model_name=MODEL_NAME,
                generation_config=generation_config,
                safety_settings={'HARM_CATEGORY_HARASSMENT': 'block_medium_and_above', 'HARM_CATEGORY_HATE_SPEECH': 'block_medium_and_above', 'HARM_CATEGORY_SEXUALLY_EXPLICIT': 'block_medium_and_above', 'HARM_CATEGORY_DANGEROUS_CONTENT': 'block_none'}
            )
            model.generate_content("test", request_options={"timeout": 60})
            ACTIVE_API_SERVICE = "Google AI (API Key)"
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –£—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ {ACTIVE_API_SERVICE}.{Colors.ENDC}")
            return
        except Exception as e:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Google AI API Key: {e}{Colors.ENDC}")
            print(f"{Colors.CYAN}üîÑ –õ–û–ì: –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç (Vertex AI)...{Colors.ENDC}")
            GOOGLE_AI_HAS_FAILED_THIS_SESSION = True
            model = None

    if GOOGLE_AI_HAS_FAILED_THIS_SESSION:
         print(f"{Colors.CYAN}üî© –õ–û–ì: –ü–æ–ø—ã—Ç–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Vertex AI...{Colors.ENDC}")
    else:
         print(f"{Colors.CYAN}üîë –õ–û–ì: API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É—é Vertex AI.{Colors.ENDC}")

    try:
        vertexai.init(project=GOOGLE_CLOUD_PROJECT, location=GOOGLE_CLOUD_LOCATION)
        model = GenerativeModel(
             model_name=MODEL_NAME,
             generation_config=generation_config,
             safety_settings={HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE, HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE}
        )
        ACTIVE_API_SERVICE = "Vertex AI"
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: Vertex AI SDK —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.{Colors.ENDC}")
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å: {e}{Colors.ENDC}")
        model = None
        ACTIVE_API_SERVICE = "N/A"

def get_active_service_details():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –º–æ–¥–µ–ª—å –∏ —Å–µ—Ä–≤–∏—Å –¥–ª—è CLI."""
    return model, ACTIVE_API_SERVICE

def send_request_to_model(model_instance, active_service, prompt_text, iteration_count=0):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–∫–µ–Ω–∞—Ö."""
    global GOOGLE_AI_HAS_FAILED_THIS_SESSION
    try:
        log_header = f"[–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}]" if iteration_count > 0 else "[–≠—Ç–∞–ø –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è]"
        print(f"{Colors.CYAN}üß† –õ–û–ì: {log_header} –ì–æ—Ç–æ–≤–ª—é –∑–∞–ø—Ä–æ—Å –≤ –º–æ–¥–µ–ª—å ({active_service}).{Colors.ENDC}")
        print(f"{Colors.CYAN}‚è≥ –õ–û–ì: –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å... (—Ç–∞–π–º–∞—É—Ç: {API_TIMEOUT_SECONDS} —Å–µ–∫){Colors.ENDC}")
        
        response = None
        if active_service == "Google AI (API Key)":
            request_options = {"timeout": API_TIMEOUT_SECONDS}
            response = model_instance.generate_content(prompt_text, request_options=request_options)
        elif active_service == "Vertex AI":
            response = model_instance.generate_content(prompt_text)
        else:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å API: {active_service}")
        
        if not response: 
            raise ValueError("–û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø—É—Å—Ç–æ–π.")
            
        print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –û—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ.{Colors.ENDC}")
        
        return {
            "text": response.text,
            "input_tokens": response.usage_metadata.prompt_token_count,
            "output_tokens": response.usage_metadata.candidates_token_count
        }
    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –û–®–ò–ë–ö–ê –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API ({active_service}): {e}{Colors.ENDC}")
        error_str = str(e).lower()
        if active_service == "Google AI (API Key)" and ("quota" in error_str or "rate limit" in error_str):
            print(f"{Colors.FAIL}üö® –õ–û–ì: –û–ë–ù–ê–†–£–ñ–ï–ù–ê –û–®–ò–ë–ö–ê –ö–í–û–¢–´!{Colors.ENDC}")
            print(f"{Colors.CYAN}   - –ü–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω–æ (–Ω–∞ —ç—Ç—É —Å–µ—Å—Å–∏—é) –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ Vertex AI...{Colors.ENDC}")
            GOOGLE_AI_HAS_FAILED_THIS_SESSION = True
            initialize_model()
        return None

def get_command_rules(stage='execution'):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞ (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ).
    """
    base_rules = f"""
**–ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê:**

1.  **–†–∞–±–æ—á–∞—è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:** –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**. **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `cd`. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–æ–ª–Ω—ã–π –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `backend/src/app.ts` –∏–ª–∏ `./backend/start.sh`).

2.  **–ü–æ–ª–Ω–æ—Ç–∞ –ö–æ–¥–∞:** **–ó–ê–ü–†–ï–©–ï–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã, –º–Ω–æ–≥–æ—Ç–æ—á–∏—è (...) –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (`// ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥`) –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ –≤ ```bash```. –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥.

3.  **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ö–æ–º–∞–Ω–¥—ã:** `{', '.join(ALLOWED_COMMANDS)}`. –ö–æ–º–∞–Ω–¥—ã, –Ω–µ –≤—Ö–æ–¥—è—â–∏–µ –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫, –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–º–µ—â–µ–Ω—ã –≤ –±–ª–æ–∫ ```manual```.

4.  **–§–æ–∫—É—Å –∏ –ü—Ä–∞–≥–º–∞—Ç–∏–∑–º:** –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Ä–µ—à–∏—Ç—å **–∏—Å—Ö–æ–¥–Ω—É—é –∑–∞–¥–∞—á—É** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ù–µ –∑–∞–Ω–∏–º–∞–π—Å—è –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º–æ–º: –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π —Å—Ç–∏–ª—å –∫–æ–¥–∞ –∏ –Ω–µ –¥–µ–ª–∞–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –∑–∞–¥–∞—á–µ–π.
"""

    if stage == 'execution':
        return f"""
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å shell-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ò–°–ü–û–õ–ù–ï–ù–ò–Ø:**

1.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ò–∑–º–µ–Ω–µ–Ω–∏–π:**
    *   **–¢–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ (`sed`):** –ò—Å–ø–æ–ª—å–∑—É–π `sed` **—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö** –∑–∞–º–µ–Ω.
    *   **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (`cat`):** –ò—Å–ø–æ–ª—å–∑—É–π `cat <<'EOF' > path/to/file.txt ... EOF` –¥–ª—è –ª—é–±—ã—Ö –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥.

2.  **–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –§–∞–π–ª–æ–≤ (–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!):**
    *   **–í–ù–ò–ú–ê–ù–ò–ï:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `cat` —Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–†–ï–î–ï–õ–¨–ù–û –ê–ö–ö–£–†–ê–¢–ï–ù. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π –≤ –±–ª–æ–∫ `EOF` **–ø–æ–ª–Ω–æ–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞.
    *   **–°—Ç—Ä–∞—Ç–µ–≥–∏—è "–û–¥–∏–Ω –∑–∞ —Ä–∞–∑":** –ï—Å–ª–∏ —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö** –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω—è–π **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –∑–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é**.

3.  **–§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞:**
    *   **–î–µ–π—Å—Ç–≤–∏—è:** –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥: ```bash ... ```.
        2.  –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–µ–≥–æ ‚Äî –±–ª–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: ```summary ... ```.
    *   **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞, –Ω–∞–ø–∏—à–∏ **—Ç–æ–ª—å–∫–æ** `–ì–û–¢–û–í–û`. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞ –¥–æ–±–∞–≤—å –±–ª–æ–∫ ```done_summary ... ```. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `npm start`), –¥–æ–±–∞–≤—å –∏—Ö –≤ –±–ª–æ–∫ ```manual```.
{base_rules}
"""

    if stage == 'planning':
        return f"""
–¢—ã ‚Äî AI-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫. –¢–≤–æ—è –ø–µ—Ä–≤–∞—è –∏ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è—Ç–µ–Ω.

**–ü–†–ê–í–ò–õ–ê –≠–¢–ê–ü–ê –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–Ø:**

1.  **–ê–Ω–∞–ª–∏–∑ –ó–∞–¥–∞—á–∏:** –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ –∑–∞–¥–∞—á—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π **—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π** –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã).
2.  **–î–≤–∞ –ü—É—Ç–∏ –†–∞–∑–≤–∏—Ç–∏—è:**
    *   **–ü—É—Ç—å –ê: –ó–∞–¥–∞—á–∞ –ù–ï–ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –Ω–µ—á–µ—Ç–∫–æ, –Ω–µ–ø–æ–ª–Ω–æ –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–ª—å–∑—è –Ω–∞–π—Ç–∏ –≤ –∫–æ–¥–µ ‚Äî **–∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é**. –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ** –±–ª–æ–∫ ```clarification ... ``` —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–ª–∞–Ω –∏ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π —Ñ–∞–π–ª—ã.
    *   **–ü—É—Ç—å –ë: –ó–∞–¥–∞—á–∞ –ü–û–ù–Ø–¢–ù–ê.** –ï—Å–ª–∏ —Ç—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. –¢–≤–æ–π –æ—Ç–≤–µ—Ç **–û–ë–Ø–ó–ê–ù** —Å–æ–¥–µ—Ä–∂–∞—Ç—å –î–í–ê –±–ª–æ–∫–∞:
        1.  **–ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π:** ```plan ... ```. –û–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–º.
        2.  **–°–ø–∏—Å–æ–∫ –§–∞–π–ª–æ–≤:** ```files ... ```. –ü–µ—Ä–µ—á–∏—Å–ª–∏ **–≤—Å–µ** —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ, –ø–æ —Ç–≤–æ–µ–º—É –º–Ω–µ–Ω–∏—é, –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞. –£–∫–∞–∑—ã–≤–∞–π –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –æ—Ç –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ. –ù–µ —ç–∫–æ–Ω–æ–º—å! –¢–≤–æ—è –∑–∞–¥–∞—á–∞ –∫–∞—á–µ—Å—Ç–≤–æ - –∑–∞–ø—Ä–æ—Å–∏ –≤—Å–µ —á—Ç–æ –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏–ª–∏ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è!!! –≠—Ç–æ –≤–∞–∂–Ω–æ - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ö–ê–ß–ï–°–¢–í–û!
3.  **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ **–ó–ê–ü–†–ï–©–ï–ù–û** –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ```bash``` –∏–ª–∏ ```summary```. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ª–∏–±–æ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –ª–∏–±–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∞–π–ª—ã.
{base_rules}
"""

def get_clarification_and_planning_prompt(context, task):
    """
    –ù–û–í–´–ô –ü–†–û–ú–ü–¢: –î–ª—è —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –≤ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.
    """
    rules = get_command_rules(stage='planning')
    return f"""{rules}

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–°–û–ö–†–ê–©–ï–ù–ù–´–ô) ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

--- –ó–ê–î–ê–ß–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
{task}
--- –ö–û–ù–ï–¶ –ó–ê–î–ê–ß–ò ---

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç. –°–ª–µ–¥—É–π –ø—Ä–∞–≤–∏–ª–∞–º —ç—Ç–∞–ø–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: –ª–∏–±–æ –∑–∞–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è (`clarification`), –ª–∏–±–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω (`plan`) –∏ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (`files`).
"""

def get_initial_prompt(context, task, fix_history=None):
    """
    –≠—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞ **—ç—Ç–∞–ø–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è**.
    """
    history_prompt_section = ""
    if fix_history:
        history_prompt_section = f"""
--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ï–ì–û –†–ï–®–ï–ù–ò–Ø, –ö–û–¢–û–†–û–ï –û–ö–ê–ó–ê–õ–û–°–¨ –ù–ï–í–ï–†–ù–´–ú ---
{fix_history}
--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–≤–æ—é –ø—Ä–æ—à–ª—É—é –æ—à–∏–±–∫—É –∏ –Ω–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ.
"""
    return f"{get_command_rules(stage='execution')}\n{history_prompt_section}\n--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–ü–û–õ–ù–´–ô –ò–õ–ò –ß–ê–°–¢–ò–ß–ù–´–ô) ---\n{context}\n--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---\n–ó–∞–¥–∞—á–∞: {task}\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–¥–∞—á—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –æ—Ç–≤–µ—Ç, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—è –ø—Ä–∞–≤–∏–ª–∞–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è."

def get_review_prompt(context, goal, iteration_count, attempt_history):
    iteration_info = ""
    if iteration_count >= 4:
        iteration_info = f"\n**–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}):** –¢—ã —É–∂–µ —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ.\n"
    history_info = ""
    if attempt_history:
        history_info = (
            "--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---\n" +
            "\n---\n".join(attempt_history) +
            "\n--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---\n"
        )
    return f"""{get_command_rules(stage='execution')}
{iteration_info}
{history_info}
**–í–ê–ñ–ù–û:** –ü—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ö–æ–¥ –Ω–∏–∂–µ ‚Äî —ç—Ç–æ **–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** –ø—Ä–æ–µ–∫—Ç–∞.

**–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø:**
1.  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â–∏–π** –∫–æ–¥, —É—á–∏—Ç—ã–≤–∞—è **–≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ç–≤–æ–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π**.
2.  –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∞—è —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –Ω–∞–ø–∏—à–∏ `–ì–û–¢–û–í–û`.
3.  –ï—Å–ª–∏ —Ü–µ–ª—å –ù–ï –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

–ù–∞–ø–æ–º–∏–Ω–∞—é –ò–°–•–û–î–ù–£–Æ –¶–ï–õ–¨: {goal}
"""

def get_error_fixing_prompt(failed_command, error_message, goal, context, iteration_count, attempt_history):
    iteration_info = ""
    if iteration_count >= 4:
        iteration_info = f"\n**–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï (–ò—Ç–µ—Ä–∞—Ü–∏—è {iteration_count}):** –¢—ã —Å–¥–µ–ª–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤, –∏ —Å–µ–π—á–∞—Å –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–±–ª–µ–º—É –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ.\n"
    history_info = ""
    if attempt_history:
        history_info = (
            "--- –ò–°–¢–û–†–ò–Ø –ü–†–ï–î–´–î–£–©–ò–• –ü–û–ü–´–¢–û–ö ---\n" +
            "\n---\n".join(attempt_history) +
            "\n--- –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ---\n"
        )
    return f"""{get_command_rules(stage='execution')}
{iteration_info}
{history_info}
**–í–ê–ñ–ù–û:** –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É, –∫–æ—Ç–æ—Ä–∞—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞. –ù–µ –ø–∏—à–∏ '–ì–û–¢–û–í–û'.

--- –î–ê–ù–ù–´–ï –û –¢–ï–ö–£–©–ï–ô –û–®–ò–ë–ö–ï ---
–ö–û–ú–ê–ù–î–ê: {failed_command}
–°–û–û–ë–©–ï–ù–ò–ï (stderr): {error_message}
--- –ö–û–ù–ï–¶ –î–ê–ù–ù–´–• –û–ë –û–®–ò–ë–ö–ï ---

–ò—Å—Ö–æ–¥–Ω–∞—è –¶–ï–õ–¨ –±—ã–ª–∞: {goal}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π **—Ç–µ–∫—É—â—É—é –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏** –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å **–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥** –∏ `summary`.

--- –ö–û–ù–¢–ï–ö–°–¢, –ì–î–ï –ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê ---
{context}
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---
"""

–§–∞–π–ª: sloth_plan.txt
--------------------
1.  **–ê–Ω–∞–ª–∏–∑ `sloth_cli.py`**: –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `main`. –ú–æ—è —Ü–µ–ª—å ‚Äî –Ω–∞–π—Ç–∏, –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏. –Ø –±—É–¥—É –∏—Å–∫–∞—Ç—å –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Ç–≤–µ—Ç –∏–ª–∏ –µ–≥–æ —á–∞—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –±–ª–æ–∫ `manual`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø") –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å. –ï—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –∞ –∑–∞—Ç–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –±–ª–æ–∫ `manual` –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –¢–∞–∫–∂–µ —è –ø—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `notify_user`.
2.  **–ê–Ω–∞–ª–∏–∑ `sloth_core.py`**: –ò–∑—É—á—É —Ñ—É–Ω–∫—Ü–∏—é `send_request_to_model`, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å, –≤ –∫–∞–∫–æ–º –≤–∏–¥–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ `sloth_cli.py`. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–∫–æ–π-–ª–∏–±–æ –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ, —Ö–æ—Ç—è —ç—Ç–æ –∏ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ.
3.  **–ê–Ω–∞–ª–∏–∑ `sloth_runner.py`**: –ü—Ä–æ–≤–µ—Ä—é —Ñ—É–Ω–∫—Ü–∏—é `execute_commands`. –•–æ—Ç—è –æ–Ω–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `bash`-–∫–æ–º–∞–Ω–¥, –≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ —Ç–∞–∫–∂–µ –≤—ã–≤–æ–¥–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫ `manual`.
4.  **–í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –°–æ–ø–æ—Å—Ç–∞–≤–∏–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Ñ–∞–π–ª–æ–≤, —è –æ—Ç—Å–ª–µ–∂—É –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏ –∏ –Ω–∞–π–¥—É –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã `print` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞ –≤—ã–≤–æ–¥ –±–ª–æ–∫–∞ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø".
5.  **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –ü–æ—Å–ª–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω—ã —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä–æ–µ —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ –≤ `sloth_cli.py`.
6.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ç—á–∞**: –Ø —Å–æ–∑–¥–∞–º `bash`-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `sed`.

–§–∞–π–ª: sloth_runner.py
---------------------
# –§–∞–π–ª: sloth_runner.py
import subprocess
import platform
import re
import hashlib
import os
from colors import Colors

def get_file_hash(filepath):
    """–í—ã—á–∏—Å–ª—è–µ—Ç SHA256 —Ö—ç—à —Ñ–∞–π–ª–∞."""
    if not os.path.exists(filepath) or os.path.isdir(filepath): return None
    h = hashlib.sha256()
    with open(filepath, 'rb') as f:
        while True:
            chunk = f.read(8192)
            if not chunk: break
            h.update(chunk)
    return h.hexdigest()

def execute_commands(commands_str):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –±–ª–æ–∫ shell-–∫–æ–º–∞–Ω–¥.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂: (success, failed_command, error_message)
    """
    print(f"{Colors.OKBLUE}  [–î–µ—Ç–∞–ª–∏] –ó–∞–ø—É—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞ –∫–æ–º–∞–Ω–¥...{Colors.ENDC}")

    # –ò–ó–ú–ï–ù–ï–ù–û: –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–∏—Å–∫–∞ –ø—É—Ç–µ–π, –≤–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ –≤ –∫–∞–≤—ã—á–∫–∞—Ö
    filepaths = re.findall(r'[\'"]?([a-zA-Z0-9_\-\.\/]+)[\'"]?', commands_str)
    
    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
    hashes_before = {fp: get_file_hash(fp) for fp in filepaths if os.path.isfile(fp)}
    dirs_before = {fp for fp in filepaths if os.path.isdir(fp)}
    files_before = {fp for fp in filepaths if os.path.exists(fp)} # –í—Å–µ –ø—É—Ç–∏, –≤–∫–ª—é—á–∞—è –ø–∞–ø–∫–∏
    
    try:
        is_macos = platform.system() == "Darwin"
        # –î–ª—è macOS –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ .bak –¥–ª—è sed -i, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ –≤ Linux
        commands_str_adapted = re.sub(r"sed -i ", "sed -i '.bak' ", commands_str) if is_macos else commands_str
        full_command = f"set -e\n{commands_str_adapted}"

        print(f"{Colors.WARNING}‚ö°Ô∏è –õ–û–ì: –í—ã–ø–æ–ª–Ω—è—é –±–ª–æ–∫ –∫–æ–º–∞–Ω–¥ (bash, set -e)...{Colors.ENDC}")
        result = subprocess.run(['bash', '-c', full_command], capture_output=True, text=True, encoding='utf-8')

        if result.returncode != 0:
            error_msg = f"–ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞ ({result.returncode}).\n–û—à–∏–±–∫–∞ (STDERR): {result.stderr.strip()}"
            print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–ª–æ–∫–∞ –∫–æ–º–∞–Ω–¥.\n{error_msg}{Colors.ENDC}")
            return False, commands_str, result.stderr.strip() or "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å –±–µ–∑ –≤—ã–≤–æ–¥–∞ –≤ stderr."

        if result.stderr:
            print(f"{Colors.WARNING}‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï (STDERR –æ—Ç —É—Å–ø–µ—à–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã):\n{result.stderr.strip()}{Colors.ENDC}")

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã .bak, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ sed –Ω–∞ macOS
        if is_macos:
            subprocess.run("find . -name '*.bak' -delete", shell=True, check=True, capture_output=True)

        # --- –ù–û–í–ê–Ø, –ë–û–õ–ï–ï –ù–ê–î–ï–ñ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô ---
        hashes_after = {fp: get_file_hash(fp) for fp in hashes_before.keys()}
        files_after = {fp for fp in filepaths if os.path.exists(fp)}

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ö—ç—à —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
        modified_files = any(hashes_before.get(fp) != hashes_after.get(fp) for fp in hashes_before)
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –ø–∞–ø–∫–∏
        created_paths = files_after - files_before
        
        if not modified_files and not created_paths:
            # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ –Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å - —ç—Ç–æ –æ—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏
            error_msg = ("–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞ –∏ –Ω–µ —Å–æ–∑–¥–∞–ª–∞ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏. "
                         "–í–µ—Ä–æ—è—Ç–Ω–æ, —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ sed) –Ω–µ –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –Ω–µ–≤–µ—Ä–µ–Ω.")
            final_error_message = result.stderr.strip() if result.stderr else error_msg
            print(f"{Colors.FAIL}‚ùå –õ–û–ì: –û–®–ò–ë–ö–ê –õ–û–ì–ò–ö–ò: {error_msg}{Colors.ENDC}")
            if result.stderr:
                print(f"–ü—Ä–∏—á–∏–Ω–∞ –∏–∑ STDERR: {final_error_message}")
            return False, commands_str, final_error_message

        # –ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è, –≤—Å–µ —Ö–æ—Ä–æ—à–æ
        if modified_files:
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –§–∞–π–ª—ã –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã.{Colors.ENDC}")
        if created_paths:
            print(f"{Colors.OKGREEN}‚úÖ –õ–û–ì: –ë–ª–æ–∫ –∫–æ–º–∞–Ω–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω. –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ –ø—É—Ç–∏: {', '.join(created_paths)}{Colors.ENDC}")
            
        return True, None, None

    except Exception as e:
        print(f"{Colors.FAIL}‚ùå –õ–û–ì: –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –û–®–ò–ë–ö–ê –≤ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ: {e}{Colors.ENDC}")
        return False, commands_str, str(e)
--- –ö–û–ù–ï–¶ –ö–û–ù–¢–ï–ö–°–¢–ê ---

–ù–∞–ø–æ–º–∏–Ω–∞—é –ò–°–•–û–î–ù–£–Æ –¶–ï–õ–¨: "‚úã –¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø: –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –∑–∞—á–µ–º-—Ç–æ 
–º–æ–∂–µ–º –ø–æ–Ω—è—Ç—å –ø—Ä–∏—á–∏–Ω—É –∏ –∏–∑–º–µ–Ω–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –ª–∏—à—å –µ–¥–∏–Ω–æ–∂–¥—ã –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ - —è –Ω–µ —Ö–æ—á—É —É—Ç–æ—á–Ω—è—Ç—å –ª–∏—à–Ω–µ–µ, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∏ –ø–æ–±–æ–ª—å—à–µ —Ñ–∞–π–ª–æ–≤ –∏ —Ä–∞–∑–±–µ—Ä–∏—Å—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ—á–µ–º—É —Ç–∞–∫ - —ç—Ç–æ –∫–æ–≥–¥–∞ –º—ã –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–æ–π –±–ª–æ–∫ –∏ –≤–æ—Ç –æ–Ω –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è


================================================================================
–û–¢–í–ï–¢ (–°–æ—Å—Ç–æ—è–Ω–∏–µ: EXECUTION, –ò—Ç–µ—Ä–∞—Ü–∏—è: 3)
--------------------------------------------------------------------------------
–ì–û–¢–û–í–û
```done_summary
–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –±–ª–æ–∫–∞ "–¢–†–ï–ë–£–Æ–¢–°–Ø –†–£–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø" –±—ã–ª–æ –≤—ã–∑–≤–∞–Ω–æ —Ç–µ–º, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ `sloth_cli.py` —Å–Ω–∞—á–∞–ª–∞ –≤—ã–≤–æ–¥–∏–ª—Å—è –æ–±—â–∏–π –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å, –∞ –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Ñ—É–Ω–∫—Ü–∏—è `notify_user`, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–µ—á–∞—Ç–∞–ª–∞ —Ç–æ –∂–µ —Å–∞–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –≤–Ω–µ—Å–µ–Ω–Ω–æ–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ, —É—Å—Ç—Ä–∞–Ω–∏–ª–æ —ç—Ç–æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–≤–æ–¥, –∏ —Ç–µ–ø–µ—Ä—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
```
